# SIC-ADS 2.0 é‡æ„å®æ–½è®¡åˆ’ (Implementation Plan)

**åˆ›å»ºæ—¥æœŸ**: 2026-02-05
**è´Ÿè´£äºº**: é¦–å¸­å®æ–½å·¥ç¨‹å¸ˆ
**å‚è€ƒæ–‡æ¡£**: é‡æ„å®æ–½æŠ€æœ¯è§„èŒƒ V1.1
**é¢„è®¡å·¥æœŸ**: 6-8 å‘¨

---

## ğŸ“Š æ€»è§ˆ (Overview)

### é˜¶æ®µåˆ’åˆ†

| é˜¶æ®µ | åç§° | å·¥æœŸ | ä¼˜å…ˆçº§ | ä¾èµ– |
|:-----|:-----|:-----|:------|:-----|
| Phase 0 | ä»£ç å®¡è®¡ä¸ä¾èµ–åˆ†æ | 3 å¤© | P0 | æ—  |
| Phase 1 | æ•°æ®åº“ä¸æŒä¹…åŒ–åº•åº§ | 2 å‘¨ | P0 | Phase 0 |
| Phase 1.5 | æ•°æ®è¿ç§»éªŒè¯ | 1 å‘¨ | P0 | Phase 1 |
| Phase 2 | èµ„æºç®¡ç†ä¸æ–‡ä»¶ç³»ç»Ÿ | 1.5 å‘¨ | P0 | Phase 1.5 |
| Phase 3 | ä¸šåŠ¡é€»è¾‘é€‚é… | 1.5 å‘¨ | P1 | Phase 2 |
| Phase 3.5 | æ€§èƒ½åŸºå‡†æµ‹è¯• | 3 å¤© | P1 | Phase 3 |

### é‡Œç¨‹ç¢‘ (Milestones)

| é‡Œç¨‹ç¢‘ | æ—¥æœŸ | äº¤ä»˜ç‰© |
|:-------|:-----|:-------|
| M0: å®¡è®¡å®Œæˆ | D+3 | å®¡è®¡æŠ¥å‘Šã€æ•°æ®æµå›¾ |
| M1: Worker åº•åº§ | D+18 | db.worker.tsã€åŸå­å†™å…¥ IPC |
| M1.5: è¿ç§»éªŒè¯ | D+25 | éªŒè¯æŠ¥å‘Šã€Rollback è„šæœ¬ |
| M2: èµ„æºç³»ç»Ÿ | D+36 | resource:// åè®®ã€Image Worker |
| M3: æ¨¡å—åŒ–å®Œæˆ | D+47 | ModuleRegistryã€DevTools |
| M3.5: æ€§èƒ½éªŒè¯ | D+50 | æ€§èƒ½æŠ¥å‘Šã€ä¼˜åŒ–å»ºè®® |

---

## Phase 0: ä»£ç å®¡è®¡ä¸ä¾èµ–åˆ†æ (Day 1-3)

### ç›®æ ‡
åœ¨é‡æ„å‰å…¨é¢äº†è§£ç°æœ‰ä»£ç ç»“æ„ï¼Œé™ä½é£é™©ã€‚

### ä»»åŠ¡æ¸…å•

#### 0.1 DatabaseAPI è°ƒç”¨å®¡è®¡ (Day 1)
**è´Ÿè´£äºº**: Backend Engineer
**æ–‡ä»¶è¾“å‡º**: `docs/audit-report.md`

```bash
# æœç´¢æ•°æ®åº“è°ƒç”¨æ¨¡å¼
grep -r "db\.exec" src/
grep -r "db\.run" src/
grep -r "database\.query" src/
grep -r "await.*API" src/views/
```

**å®¡è®¡æ¨¡æ¿**:
```markdown
## DatabaseAPI è°ƒç”¨ç»Ÿè®¡

### è°ƒç”¨é¢‘ç‡ Top 10
| æ’å | æ–‡ä»¶ | è°ƒç”¨æ¬¡æ•° | æ“ä½œç±»å‹ | ä¼˜åŒ–å»ºè®® |
|:-----|:-----|:---------|:---------|:---------|
| 1 | src/views/Dashboard.vue | 45 | æŸ¥è¯¢ | éœ€è¦æ‰¹é‡åˆå¹¶ |
| 2 | ... | ... | ... | ... |

### IPC é€šè®¯ç‚¹ç»Ÿè®¡
| æ¥å£ | è°ƒç”¨ä½ç½® | é¢‘ç‡ | æ•°æ®å¤§å° |
|:-----|:---------|:-----|:---------|
| ... | ... | ... | ... |
```

#### 0.2 ability_tags ä½¿ç”¨æ¨¡å¼åˆ†æ (Day 2)
**è´Ÿè´£äºº**: Data Engineer
**æ–‡ä»¶è¾“å‡º**: `docs/ability-tags-analysis.md`

```bash
# æœç´¢ ability_tags çš„æ‰€æœ‰ä½¿ç”¨ä½ç½®
grep -r "ability_tags" src/
grep -r "\.join\|\.some" src/ | grep -i tag
```

**æ£€æŸ¥æ¸…å•**:
- [ ] `ability_tags` æ˜¯å¦éƒ½æ˜¯ JSON å­—ç¬¦ä¸²ï¼Ÿ
- [ ] æ‰€æœ‰ `.join()` è°ƒç”¨æ˜¯å¦éƒ½æœ‰ `ensureArray()` ä¿æŠ¤ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ç›´æ¥æ•°ç»„æ“ä½œ (`[0]`, `.map()`, `.filter()`)ï¼Ÿ

#### 0.3 æ•°æ®æµå›¾ç»˜åˆ¶ (Day 3)
**è´Ÿè´£äºº**: System Architect
**æ–‡ä»¶è¾“å‡º**: `docs/data-flow-diagram.md`

**æµç¨‹ 1: è¯„ä¼°æ•°æ®æµ**
```
ç”¨æˆ·é€‰æ‹©å­¦ç”Ÿ -> åŠ è½½å­¦ç”Ÿæ¡£æ¡ˆ -> åˆ›å»ºè¯„ä¼°è®°å½•
  -> ä¿å­˜ç­”æ¡ˆ -> è®¡ç®—åˆ†æ•° -> ç”ŸæˆæŠ¥å‘Š -> IEP ç”Ÿæˆ
```
æ ‡è®°æ‰€æœ‰ IPC é€šè®¯ç‚¹ã€æ•°æ®åº“å†™å…¥ç‚¹ã€ç¼“å­˜ç‚¹ã€‚

**æµç¨‹ 2: è®­ç»ƒè®°å½•å†™å…¥æµ**
```
æ¸¸æˆç»“æŸ -> æ”¶é›†è®­ç»ƒæ•°æ® -> è®¡ç®—èƒ½åŠ›æ ‡ç­¾
  -> å†™å…¥ training_records -> æ›´æ–°å­¦ç”Ÿç»Ÿè®¡ -> ç”Ÿæˆ IEP
```

### éªŒæ”¶æ ‡å‡†
- [ ] å®¡è®¡æŠ¥å‘ŠåŒ…å«è‡³å°‘ 5 ä¸ªé«˜é¢‘è°ƒç”¨ç‚¹çš„ä¼˜åŒ–å»ºè®®
- [ ] æ•°æ®æµå›¾æ ‡æ³¨äº†æ‰€æœ‰ IPC é€šè®¯ç‚¹
- [ ] ability_tags é£é™©ç‚¹åˆ—è¡¨å®Œæˆ

---

## Phase 1: æ•°æ®åº“ä¸æŒä¹…åŒ–åº•åº§ (Day 4-18)

### ç›®æ ‡
å®ç° Web Worker æ•°æ®åº“å±‚å’Œæ–°è¡¨ç»“æ„ã€‚

### ä»»åŠ¡æ¸…å•

#### 1.1 Worker ç¯å¢ƒæ­å»º (Day 4-7) âœ… å·²å®Œæˆ
**è´Ÿè´£äºº**: Backend Engineer
**å®Œæˆæ—¥æœŸ**: 2026-02-05

**æ–‡ä»¶è¾“å‡º**:
- [x] `src/workers/types/worker-messages.ts` - ç±»å‹å®šä¹‰
- [x] `src/workers/command-queue.ts` - æ‰¹é‡é˜Ÿåˆ—ï¼ˆ50ms é˜²æŠ–ï¼‰
- [x] `src/workers/db.worker.ts` - Worker å®ç°ï¼ˆå«æµ‹è¯•æ¨¡å¼é™çº§ï¼‰
- [x] `src/workers/db-bridge.ts` - ä¸»çº¿ç¨‹æ¡¥æ¥
- [x] `src/views/devtools/WorkerTest.vue` - æµ‹è¯•ç»„ä»¶
- [x] `public/worker-test.html` - ç‹¬ç«‹æµ‹è¯•é¡µé¢

**å­ä»»åŠ¡**:
1. **[x] åˆ›å»º Worker æ¨¡æ¿** (Day 4)
   - å®ç° `db.worker.ts`ï¼Œæ”¯æŒ init/query/batch_query/ping/close æ¶ˆæ¯ç±»å‹
   - æµ‹è¯•æ¨¡å¼é™çº§ï¼šsql.js ä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æµ‹è¯•æ¨¡å¼
   - é€šè¿‡ Vite worker å¯¼å…¥è¯­æ³•ï¼š`import DbWorker from './db.worker.ts?worker'`

2. **[x] å®ç° DatabaseCommandQueue** (Day 5)
   - æ‰¹é‡åˆå¹¶çª—å£ï¼š50ms é˜²æŠ–
   - æœ€å¤§æ‰¹é‡å¤§å°ï¼š50 æ¡æ“ä½œ
   - ä¼˜åŒ– postMessage å¼€é”€ï¼šç›¸é‚»æŸ¥è¯¢åˆå¹¶å‘é€

3. **[ ] è¿ç§» DatabaseAPI** (Day 6-7) - å¾…å®Œæˆ
   - å°† `src/database/api.ts` ä¸­çš„æ‰€æœ‰æ–¹æ³•æ”¹ä¸ºé€šè¿‡ Bridge è°ƒç”¨
   - ä¿æŒ API æ¥å£ä¸å˜ï¼Œç¡®ä¿å‘åå…¼å®¹

#### 1.2 Schema è¿ç§» (Day 8-14) âœ… éƒ¨åˆ†å®Œæˆ
**è´Ÿè´£äºº**: Data Engineer
**å®Œæˆæ—¥æœŸ**: 2026-02-05

**æ–‡ä»¶è¾“å‡º**:
- [x] `src/database/migration/schema-migration.ts` - å®Œæ•´è¿ç§»è„šæœ¬
- [x] `src/views/devtools/SchemaMigration.vue` - è¿ç§»å·¥å…·ç•Œé¢

**å­ä»»åŠ¡**:
1. **[x] åˆ›å»ºæ–°è¡¨ç»“æ„** (Day 8-9)
   - âœ… `sys_training_resource` - æ ¸å¿ƒèµ„æºè¡¨ï¼ˆ18 ä¸ªå­—æ®µï¼‰
   - âœ… `sys_tags` - æ ‡ç­¾å­—å…¸è¡¨ï¼ˆdomain + name å”¯ä¸€ï¼‰
   - âœ… `sys_resource_tag_map` - èµ„æº-æ ‡ç­¾å…³è”è¡¨
   - âœ… `sys_favorites` - ç»Ÿä¸€æ”¶è—å¤¹è¡¨
   - âœ… `sys_app_settings` - ç³»ç»Ÿé…ç½® KV å­˜å‚¨è¡¨
   - âœ… 5 ä¸ªç´¢å¼•ï¼ˆmodule, type, category, legacy, domainï¼‰

2. **[x] æ•°æ®è¿ç§»è„šæœ¬** (Day 10-12)
   - âœ… é¢„æ£€å¤‡ä»½æ£€æŸ¥ï¼ˆ`backupDatabase()`ï¼‰
   - âœ… FTS5 å…¼å®¹æ€§æ£€æµ‹ä¸é™çº§ï¼ˆå½“å‰ä½¿ç”¨ LIKE é™çº§ï¼‰
   - âœ… ability_tags JSON å®‰å…¨è§£æï¼ˆ`safeParseAbilityTags()`ï¼‰
   - âœ… Equipment -> Resource è¿ç§»ï¼š62 æ¡å™¨æ â†’ 62 æ¡èµ„æº âœ…
   - âœ… Tag å»é‡ä¸æ˜ å°„ï¼šè§£æå‡º 93 ä¸ªå”¯ä¸€æ ‡ç­¾
   - âœ… teacher_fav è¿ç§»ï¼ˆè¡¨ä¸ºç©ºï¼Œè·³è¿‡ï¼‰
   - âœ… åŒé‡éªŒè¯ï¼šCOUNT å¯¹æ¯” 62 = 62 âœ…

3. **[x] FTS5 æ£€æµ‹ä¸é™çº§** (Day 13-14)
   - âœ… `detectFTS5Support()` - è¿è¡Œæ—¶æ£€æµ‹ FTS5 æ”¯æŒ
   - âœ… é™çº§æ–¹æ¡ˆï¼š`[WARN] FTS5 not supported, utilizing LIKE fallback`
   - â³ `ResourceSearchService` - å¾…å®ç°ï¼ˆPhase 1.5ï¼‰

**è¿ç§»ç»“æœ**:
```
equipment_catalog:     62 æ¡
sys_training_resource:  62 æ¡ âœ…
sys_tags:               93 ä¸ª
sys_favorites:          0 æ¡
FTS5 æ”¯æŒ:              âŒ (é™çº§åˆ° LIKE)
```

#### 1.4 åŸå­å†™å…¥ä¸æŒä¹…åŒ– (Day 15-18) âœ… å·²å®Œæˆ
**è´Ÿè´£äºº**: System Architect + Backend Engineer
**å®Œæˆæ—¥æœŸ**: 2026-02-05
**å®ç°æ–¹æ¡ˆ**: Plan B - ä¸»çº¿ç¨‹é˜²æŠ–åŸå­å†™å…¥

**æ¶æ„å†³ç­–**ï¼š
ç»è¿‡å¤šæ¬¡å°è¯• Worker æ–¹æ¡ˆåï¼Œæ¶æ„å¸ˆå†³å®šé‡‡ç”¨ **Plan B**ï¼š
- âŒ æ”¾å¼ƒ Worker æ–¹æ¡ˆï¼šVite Worker æ‰“åŒ…ä¸ sql.js CommonJS å…¼å®¹æ€§é—®é¢˜æ— æ³•è§£å†³
- âœ… é‡‡ç”¨ä¸»çº¿ç¨‹é˜²æŠ–ï¼šINSERT/UPDATE/DELETE è§¦å‘ 2000ms é˜²æŠ–ä¿å­˜
- âœ… åŸå­å†™å…¥ä¿è¯ï¼šé€šè¿‡ `electronAPI.saveDatabaseAtomic()` å®ç°ä¸‰æ­¥å†™å…¥

**æ–‡ä»¶è¾“å‡º**:
- [x] `src/database/sql-wrapper.ts` - é‡å†™å®Œæˆï¼Œå†…ç½®é˜²æŠ–ä¿å­˜
- [x] `electron/main.js` - `saveDatabaseAtomic` IPC handlerï¼ˆfsync + renameï¼‰
- [x] `src/database/init.ts` - ç§»é™¤ Worker Bridge åˆå§‹åŒ–
- [x] `src/database/api.ts` - ç§»é™¤æ‰€æœ‰ Worker ç›¸å…³ä»£ç 
- [x] `src/main.ts` - æ›´æ–° beforeunload å¤„ç†å™¨

**å­ä»»åŠ¡**:
1. **[x] Main Process åŸå­å†™å…¥** (2026-02-05)
   ```typescript
   // electron/main.js
   ipcMain.handle('saveDatabaseAtomic', async (_event, data, dbName) => {
     const tmpPath = dbPath + '.tmp'
     await fs.writeFile(tmpPath, new Uint8Array(data))
     await fs.fsync(await fs.open(tmpPath, 'r'))
     await fs.rename(tmpPath, dbPath)
     return { success: true, filePath: dbPath }
   })
   ```

2. **[x] SQLWrapper é˜²æŠ–ä¿å­˜** (2026-02-05)
   ```typescript
   // src/database/sql-wrapper.ts
   private triggerDebouncedSave(): void {
     if (this.saveTimer !== null) {
       clearTimeout(this.saveTimer)
     }
     this.isDirty = true
     this.saveTimer = setTimeout(() => {
       this.performAtomicSave()
     }, 2000)
   }
   ```

3. **[x] ç§»é™¤ Worker ä¾èµ–** (2026-02-05)
   - åˆ é™¤ `src/database/init.ts` ä¸­çš„ Worker Bridge åˆå§‹åŒ–
   - åˆ é™¤ `src/database/api.ts` ä¸­çš„ `useBridge` é€»è¾‘
   - æ›´æ–° `src/main.ts` ä¸­çš„ beforeunload å¤„ç†å™¨

### éªŒæ”¶æ ‡å‡†
- [x] Worker ç›¸å…³ä»£ç å·²å®Œå…¨ç§»é™¤
- [x] INSERT/UPDATE/DELETE è‡ªåŠ¨è§¦å‘ 2000ms é˜²æŠ–ä¿å­˜
- [x] æ•°æ®åº“å¯¼å‡ºé€šè¿‡ IPC åŸå­å†™å…¥ï¼ˆfsync + renameï¼‰
- [x] åº”ç”¨é€€å‡ºå‰è°ƒç”¨ `saveNow()` ç«‹å³ä¿å­˜

#### 1.4.1 PSQ/TRS æŠ¥å‘Šè®°å½•ä¿®å¤ âœ… å·²å®Œæˆ (2026-02-05)
**é—®é¢˜**: PSQ/TRS è¯„ä¼°å®Œæˆåï¼ŒæŠ¥å‘Šç”Ÿæˆæ¨¡å—å’Œå­¦ç”Ÿè¯¦æƒ…é¡µæ‰¾ä¸åˆ°è¯„ä¼°è®°å½•

**æ ¹æœ¬åŸå› **:
1. `ReportAPI.saveReportRecord()` ç±»å‹å®šä¹‰ä¸åŒ…å« `'conners-psq'` å’Œ `'conners-trs'`
2. æ•°æ®åº“ `report_record` è¡¨çš„ CHECK çº¦æŸä¸åŒ…å«è¿™ä¸¤ç§ç±»å‹
3. å­¦ç”Ÿè¯¦æƒ…é¡µåªæŸ¥è¯¢ S-M å’Œ WeeFIMï¼ŒæœªæŸ¥è¯¢ PSQ/TRS

**ä¿®å¤å†…å®¹**:
- [x] æ›´æ–° `src/database/api.ts` ç±»å‹å®šä¹‰ï¼Œæ·»åŠ  `csirs | conners-psq | conners-trs | iep`
- [x] æ·»åŠ  `src/database/sql-wrapper.ts` çš„ `getRawDB()` æ–¹æ³•
- [x] ä¿®å¤ `src/database/migrate-report-constraints.ts` è¿ç§»è„šæœ¬
- [x] åœ¨ `src/database/init.ts` æ·»åŠ è‡ªåŠ¨è¿ç§»é€»è¾‘
- [x] æ›´æ–° `src/views/StudentDetail.vue` æ·»åŠ  PSQ/TRS/CSIRS è¯„ä¼°è®°å½•æŸ¥è¯¢
- [x] ä¿®å¤ `src/main.ts` æŠ‘åˆ¶ ResizeObserver è­¦å‘Š

**æ–‡ä»¶ä¿®æ”¹**:
| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `src/database/api.ts` | æ·»åŠ  conners-psq/trs ç±»å‹ |
| `src/database/sql-wrapper.ts` | æ·»åŠ  getRawDB() æ–¹æ³• |
| `src/database/migrate-report-constraints.ts` | ä¿®å¤è¿ç§»è„šæœ¬ |
| `src/database/init.ts` | æ·»åŠ è‡ªåŠ¨è¿ç§» + æ‰‹åŠ¨è¿ç§»å¯¼å‡º |
| `src/main.ts` | æŠ‘åˆ¶ ResizeObserver è­¦å‘Š |
| `src/views/StudentDetail.vue` | æ·»åŠ  PSQ/TRS/CSIRS æŸ¥è¯¢ |

#### 1.5 [å·²åºŸå¼ƒ] åŸå­å†™å…¥å®ç° (åŸè®¡åˆ’)
**çŠ¶æ€**: å·²åºŸå¼ƒï¼Œè¢« 1.4 Plan B å–ä»£
**åŸå› **: Worker ç¯å¢ƒä¸ sql.js å…¼å®¹æ€§é—®é¢˜æ— æ³•è§£å†³
**è´Ÿè´£äºº**: Electron Engineer
**æ–‡ä»¶è¾“å‡º**:
- `electron/services/database-persistence.ts`
- `electron/ipc-handlers/database.ts`

**å­ä»»åŠ¡**:
1. **Main Process æŒä¹…åŒ–æœåŠ¡** (Day 15-16)
   ```typescript
   // electron/services/database-persistence.ts
   import fs from 'fs/promises'

   export class DatabasePersistenceService {
     async saveAtomic(data: Buffer, dbPath: string): Promise<void> {
       const tmpPath = dbPath + '.tmp'
       await fs.writeFile(tmpPath, data)
       await fs.fsync(await fs.open(tmpPath, 'r'))
       await fs.rename(tmpPath, dbPath)
     }
   }
   ```

2. **IPC Handler å®ç°** (Day 17)
   ```typescript
   // electron/ipc-handlers/database.ts
   ipcMain.handle('db:save', async (_event, data: Buffer) => {
     const dbPath = path.join(app.getPath('userData'), 'database.sqlite')
     await persistenceService.saveAtomic(data, dbPath)
     return { success: true }
   })
   ```

3. **Worker é˜²æŠ–ä¿å­˜** (Day 18)
   ```typescript
   // src/workers/db.worker.ts
   class DebouncedSave {
     private timer: NodeJS.Timeout | null = null

     schedule(data: Buffer) {
       if (this.timer) clearTimeout(this.timer)
       this.timer = setTimeout(() => {
         ipcRenderer.invoke('db:save', data)
       }, 2000)  // 2ç§’é˜²æŠ–
     }
   }
   ```

### éªŒæ”¶æ ‡å‡†
- [ ] Worker æˆåŠŸè¿è¡Œï¼Œæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- [ ] FTS5 ä¸å¯ç”¨æ—¶èƒ½é™çº§åˆ° LIKE æŸ¥è¯¢
- [ ] åŸå­å†™å…¥åœ¨æ–­ç”µæµ‹è¯•ä¸­ä¸ä¸¢å¤±æ•°æ®

---

## Phase 1.5: æ•°æ®è¿ç§»éªŒè¯ (Day 19-25)

### ç›®æ ‡
ç¡®ä¿æ•°æ®è¿ç§»çš„æ­£ç¡®æ€§å’Œå®Œæ•´æ€§ã€‚

### ä»»åŠ¡æ¸…å•

#### 1.5.1 éªŒè¯è„šæœ¬ (Day 19-21)
**è´Ÿè´£äºº**: QA Engineer
**æ–‡ä»¶è¾“å‡º**:
- `src/database/migration/migration-verification.ts`
- `tests/migration.spec.ts`

**å­ä»»åŠ¡**:
1. **å®ç° verifyMigration å‡½æ•°** (Day 19)
   ```typescript
   // src/database/migration/migration-verification.ts
   export async function verifyMigration(db: Database): Promise<VerificationReport> {
     // å®ç° Section 7.3 ä¸­çš„éªŒè¯é€»è¾‘
   }
   ```

2. **ç¼–å†™æµ‹è¯•ç”¨ä¾‹** (Day 20-21)
   ```typescript
   // tests/migration.spec.ts
   describe('Equipment -> Resource Migration', () => {
     it('should migrate all 62 equipment items', async () => {
       // ...
     })

     it('should preserve tag relationships', async () => {
       // ...
     })

     it('should handle empty tags correctly', async () => {
       // ...
     })
   })
   ```

#### 1.5.2 Rollback è„šæœ¬ (Day 22-23)
**è´Ÿè´£äºº**: Data Engineer
**æ–‡ä»¶è¾“å‡º**: `src/database/migration/rollback-migration.sql`

```sql
-- å®ç° Section 7.3 ä¸­çš„ Rollback é€»è¾‘
BEGIN;

-- åˆ é™¤æ–°è¡¨
DROP TABLE IF EXISTS sys_resource_tag_map;
-- ...

COMMIT;
```

#### 1.5.3 åŒå†™éªŒè¯ (Day 24-25)
**è´Ÿè´£äºº**: Backend Engineer
**æ–‡ä»¶è¾“å‡º**:
- `src/database/migration/compatibility-adapter.ts`
- `src/database/migration/dual-write-flag.ts`

**å­ä»»åŠ¡**:
1. **å®ç° CompatibilityAdapter** (Day 24)
   ```typescript
   // src/database/migration/compatibility-adapter.ts
   // å®ç° Section 8.3 ä¸­çš„åŒå†™é€»è¾‘
   ```

2. **åŒå†™å¼€å…³** (Day 25)
   ```typescript
   // ä»…åœ¨å¼€å‘ç¯å¢ƒå¯ç”¨
   const DUAL_WRITE_ENABLED = import.meta.env.DEV && process.env.VITE_DUAL_WRITE === 'true'

   if (DUAL_WRITE_ENABLED) {
     await adapter.dualWriteEquipment(oldApi, newApi, data)
   }
   ```

### éªŒæ”¶æ ‡å‡†
- [ ] æ‰€æœ‰éªŒè¯æ£€æŸ¥é¡¹é€šè¿‡
- [ ] åŒå†™éªŒè¯æ•°æ®ä¸€è‡´æ€§ 100%
- [ ] Rollback è„šæœ¬æµ‹è¯•æˆåŠŸ

---

## Phase 2: èµ„æºç®¡ç†ä¸æ–‡ä»¶ç³»ç»Ÿ (Day 26-36)

### ç›®æ ‡
å®ç° resource:// åè®®å’Œå›¾ç‰‡å¤„ç†ç®¡é“ã€‚

### ä»»åŠ¡æ¸…å•

#### 2.1 åè®®æ³¨å†Œ (Day 26-28)
**è´Ÿè´£äºº**: Electron Engineer
**æ–‡ä»¶è¾“å‡º**:
- `electron/protocols/resource.ts`
- `electron/protocols/index.ts`

**å­ä»»åŠ¡**:
1. **å®ç° safeResolveResource** (Day 26)
   ```typescript
   // electron/protocols/resource.ts
   // å®ç° Section 7.5 ä¸­çš„å®‰å…¨è·¯å¾„è§£æ
   ```

2. **æ³¨å†Œåè®®** (Day 27-28)
   ```typescript
   // electron/main.ts
   import { registerResourceProtocol } from './protocols'

   app.whenReady().then(() => {
     registerResourceProtocol()
   })
   ```

#### 2.2 Image Worker (Day 29-32)
**è´Ÿè´£äºº**: Frontend Engineer
**æ–‡ä»¶è¾“å‡º**:
- `src/workers/image.worker.ts`
- `src/utils/image-compression.ts`

**å­ä»»åŠ¡**:
1. **å®‰è£…ä¾èµ–** (Day 29)
   ```bash
   npm install browser-image-compression --save
   ```

2. **å®ç° ImageProcessor** (Day 30-31)
   ```typescript
   // src/workers/image.worker.ts
   // å®ç° Section 7.4 ä¸­çš„å›¾ç‰‡å¤„ç†é€»è¾‘
   ```

3. **ç‰¹æ€§æ£€æµ‹** (Day 32)
   ```typescript
   // æ£€æµ‹ OffscreenCanvas å’Œ browser-image-compression å¯ç”¨æ€§
   ```

#### 2.3 æ–‡ä»¶ IO IPC (Day 33-34)
**è´Ÿè´£äºº**: Electron Engineer
**æ–‡ä»¶è¾“å‡º**:
- `electron/ipc-handlers/assets.ts`
- `electron/services/asset-manager.ts`

**å­ä»»åŠ¡**:
1. **å®ç° SAVE_ASSET** (Day 33)
   ```typescript
   ipcMain.handle('asset:save', async (_event, filename: string, data: Buffer) => {
     const assetPath = path.join(app.getPath('userData'), 'resource_assets', filename)
     await fs.writeFile(assetPath, data)
     return { success: true, path: assetPath }
   })
   ```

2. **å®ç° DELETE_ASSET** (Day 34)
   ```typescript
   ipcMain.handle('asset:delete', async (_event, filename: string) => {
     const assetPath = path.join(app.getPath('userData'), 'resource_assets', filename)
     await fs.unlink(assetPath)
     return { success: true }
   })
   ```

#### 2.4 å‰ç«¯æ”¹é€  (Day 35-36)
**è´Ÿè´£äºº**: Frontend Engineer
**æ–‡ä»¶è¾“å‡º**:
- `src/components/resources/ResourceUpload.vue`
- `src/components/resources/ResourcePreview.vue`

### éªŒæ”¶æ ‡å‡†
- [ ] resource:// åè®®èƒ½æ­£ç¡®åŠ è½½å›¾ç‰‡
- [ ] è·¯å¾„éå†æ”»å‡»æµ‹è¯•è¢«æ‹¦æˆª
- [ ] å›¾ç‰‡å‹ç¼©åœ¨ 100ms å†…å®Œæˆï¼ˆ1920x1080 è¾“å…¥ï¼‰

---

## Phase 3: ä¸šåŠ¡é€»è¾‘é€‚é… (Day 37-47)

### ç›®æ ‡
å®ç°æ¨¡å—åŒ–æ¶æ„å’Œå¼€å‘è€…å·¥å…·ã€‚

### ä»»åŠ¡æ¸…å•

#### 3.1 æ¨¡å—æ¥å£å¥‘çº¦ (Day 37-40)
**è´Ÿè´£äºº**: System Architect
**æ–‡ä»¶è¾“å‡º**:
- `src/types/module.ts`
- `src/config/modules.ts`

**å­ä»»åŠ¡**:
1. **å®šä¹‰ ModuleInterface** (Day 37)
   ```typescript
   // src/types/module.ts
   // å®ç° Section 8.1 ä¸­çš„æ¥å£å®šä¹‰
   ```

2. **å®ç° ModuleRegistry** (Day 38-39)
   ```typescript
   // src/config/modules.ts
   export class ModuleRegistry {
     // å®ç° Section 8.1 ä¸­çš„æ³¨å†Œè¡¨é€»è¾‘
   }
   ```

3. **å®šä¹‰ç³»ç»Ÿæ¨¡å—** (Day 40)
   ```typescript
   // src/config/modules.ts
   export const SystemModules = {
     // å®ç° Section 5.4 ä¸­çš„æ¨¡å—å®šä¹‰
   }
   ```

#### 3.2 ä¸šåŠ¡é€»è¾‘é‡æ„ (Day 41-44)
**è´Ÿè´£äºº**: Backend Engineer
**æ–‡ä»¶è¾“å‡º**:
- `src/components/resources/ResourceSelector.vue` (é‡æ„)
- `src/utils/iep-generator.ts` (é‡æ„)

**å­ä»»åŠ¡**:
1. **é‡æ„ ResourceSelector** (Day 41-42)
   - å¯¹æ¥æ–°çš„ `sys_training_resource` è¡¨
   - æ”¯æŒæ¨¡å—ç­›é€‰ (`module_code`)
   - é›†æˆ `ResourceSearchService`

2. **é‡æ„ IEPGenerator** (Day 43-44)
   - ä½¿ç”¨ç­–ç•¥æ¨¡å¼
   - æ¯ä¸ªæ¨¡å—å®ç°ç‹¬ç«‹çš„ `IEPStrategy`

#### 3.3 å¼€å‘è€…å·¥å…· (Day 45-47)
**è´Ÿè´£äºº**: Frontend Engineer
**æ–‡ä»¶è¾“å‡º**:
- `src/views/devtools/ModuleDevTools.vue`

### éªŒæ”¶æ ‡å‡†
- [ ] æ‰€æœ‰æ¨¡å—å®ç° `ModuleInterface`
- [ ] å¼€å‘è€…å·¥å…·èƒ½åŠ¨æ€å¯ç”¨/ç¦ç”¨æ¨¡å—
- [ ] License æ§åˆ¶æ¨¡å—è®¿é—®æ­£å¸¸å·¥ä½œ

---

## Phase 3.5: æ€§èƒ½åŸºå‡†æµ‹è¯• (Day 48-50)

### ç›®æ ‡
ç¡®ä¿é‡æ„åæ€§èƒ½ä¸ä½äºåŸæœ‰æ°´å¹³ã€‚

### ä»»åŠ¡æ¸…å•

#### 3.5.1 åŸºå‡†æµ‹è¯•å¥—ä»¶ (Day 48)
**è´Ÿè´£äºº**: Performance Engineer
**æ–‡ä»¶è¾“å‡º**:
- `tests/performance/benchmark.ts`

**æµ‹è¯•åœºæ™¯**:
1. æ‰¹é‡æŸ¥è¯¢ï¼ˆ1000æ¡ï¼‰
2. å•ä¸ªå†™å…¥
3. æœç´¢å“åº”æ—¶é—´
4. Worker é€šè®¯å»¶è¿Ÿ

#### 3.5.2 å¯¹æ¯”æŠ¥å‘Š (Day 49)
**è´Ÿè´£äºº**: Performance Engineer
**æ–‡ä»¶è¾“å‡º**: `docs/performance-report.md`

**æŠ¥å‘Šå†…å®¹**:
```markdown
# æ€§èƒ½å¯¹æ¯”æŠ¥å‘Š

## æµ‹è¯•ç¯å¢ƒ
- CPU: ...
- RAM: ...
- Node.js: ...

## æ‰¹é‡æŸ¥è¯¢ï¼ˆ1000æ¡ï¼‰
| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | å˜åŒ– |
|:-----|:-------|:-------|:-----|
| å¹³å‡å“åº”æ—¶é—´ | 120ms | 95ms | -20.8% |
| P95 å“åº”æ—¶é—´ | 180ms | 140ms | -22.2% |
```

#### 3.5.3 ä¼˜åŒ–è¿­ä»£ (Day 50)
**è´Ÿè´£äºº**: Performance Engineer

**æ ¹æ®æµ‹è¯•ç»“æœä¼˜åŒ–**:
- Worker é€šè®¯ä¼˜åŒ–
- æŸ¥è¯¢ç»“æœç¼“å­˜
- æ‰¹é‡æ“ä½œä¼˜åŒ–

### éªŒæ”¶æ ‡å‡†
- [ ] æ‰¹é‡æŸ¥è¯¢æ€§èƒ½ä¸ä½äºåŸç³»ç»Ÿçš„ 90%
- [ ] æœç´¢å“åº”æ—¶é—´ < 200ms
- [ ] æ— å†…å­˜æ³„æ¼ï¼ˆè¿ç»­è¿è¡Œ 24 å°æ—¶æµ‹è¯•ï¼‰

---

## ğŸ“ æ–‡ä»¶ç»“æ„è§„åˆ’

```
src/
â”œâ”€â”€ workers/
â”‚   â”œâ”€â”€ db.worker.ts              # æ•°æ®åº“ Worker
â”‚   â”œâ”€â”€ image.worker.ts           # å›¾ç‰‡å¤„ç† Worker
â”‚   â””â”€â”€ db-bridge.ts              # ä¸»çº¿ç¨‹æ¡¥æ¥
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ schema/
â”‚   â”‚   â””â”€â”€ sys-tables.sql        # æ–°è¡¨ç»“æ„
â”‚   â”œâ”€â”€ migration/
â”‚   â”‚   â”œâ”€â”€ migrate-to-resource.ts
â”‚   â”‚   â”œâ”€â”€ migration-verification.ts
â”‚   â”‚   â”œâ”€â”€ rollback-migration.sql
â”‚   â”‚   â”œâ”€â”€ verify-before-migrate.sql
â”‚   â”‚   â””â”€â”€ compatibility-adapter.ts
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ resource-search.ts    # FTS5/é™çº§æŸ¥è¯¢
â”‚   â””â”€â”€ api.ts                    # é‡æ„åçš„ API
â”œâ”€â”€ types/
â”‚   â””â”€â”€ module.ts                 # æ¨¡å—æ¥å£å®šä¹‰
â”œâ”€â”€ config/
â”‚   â””â”€â”€ modules.ts                # æ¨¡å—æ³¨å†Œè¡¨
â”œâ”€â”€ components/
â”‚   â””â”€â”€ resources/
â”‚       â”œâ”€â”€ ResourceUpload.vue
â”‚       â”œâ”€â”€ ResourceSelector.vue  # é‡æ„
â”‚       â””â”€â”€ ResourcePreview.vue
â”œâ”€â”€ views/
â”‚   â””â”€â”€ devtools/
â”‚       â””â”€â”€ ModuleDevTools.vue
â””â”€â”€ utils/
    â””â”€â”€ iep-generator.ts           # é‡æ„

electron/
â”œâ”€â”€ protocols/
â”‚   â””â”€â”€ resource.ts               # resource:// åè®®
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ database-persistence.ts
â”‚   â””â”€â”€ asset-manager.ts
â””â”€â”€ ipc-handlers/
    â”œâ”€â”€ database.ts
    â””â”€â”€ assets.ts

tests/
â”œâ”€â”€ migration.spec.ts
â””â”€â”€ performance/
    â””â”€â”€ benchmark.ts
```

---

## ğŸ”§ å¼€å‘ç¯å¢ƒå‡†å¤‡

### æ–°å¢ä¾èµ–

```bash
# å›¾ç‰‡å¤„ç†ï¼ˆçº¯ JSï¼‰
npm install browser-image-compression --save

# æµå¼å‹ç¼©ï¼ˆçº¯ JSï¼‰
npm install archiver --save

# ç±»å‹å®šä¹‰
npm install @types/archiver --save-dev
```

### ç¯å¢ƒå˜é‡

```bash
# .env.development
VITE_DUAL_WRITE=true       # å¯ç”¨åŒå†™éªŒè¯
VITE_DEV_TOOLS=true        # å¯ç”¨å¼€å‘è€…å·¥å…·

# .env.production
VITE_DUAL_WRITE=false
VITE_DEV_TOOLS=false
```

---

## ğŸ“‹ é£é™©ç®¡ç†

### é«˜é£é™©é¡¹

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ | è´Ÿè´£äºº |
|:-----|:-----|:---------|:-------|
| æ•°æ®è¿ç§»å¤±è´¥ | é«˜ | åŒå†™éªŒè¯ã€Rollback è„šæœ¬ | Data Engineer |
| Worker é€šè®¯æ€§èƒ½ | ä¸­ | Command Queueã€æ‰¹é‡åˆå¹¶ | Backend Engineer |
| FTS5 ä¸å…¼å®¹ | ä½ | LIKE é™çº§æ–¹æ¡ˆ | Backend Engineer |

### å›æ»šè®¡åˆ’

å¦‚æœæŸä¸ª Phase æ— æ³•å®Œæˆï¼š
1. **Phase 1 å¤±è´¥**: å›é€€åˆ°åŸæ•°æ®åº“ç»“æ„ï¼Œä¿ç•™å®¡è®¡æŠ¥å‘Š
2. **Phase 1.5 å¤±è´¥**: ä½¿ç”¨ Rollback è„šæœ¬æ¢å¤æ—§è¡¨
3. **Phase 2 å¤±è´¥**: æš‚åœå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ï¼Œä½¿ç”¨å ä½ç¬¦
4. **Phase 3 å¤±è´¥**: å»¶è¿Ÿæ¨¡å—åŒ–ï¼Œä¿æŒç°æœ‰æ¶æ„

---

## ğŸ“Š è¿›åº¦è·Ÿè¸ª

### æ¯æ—¥ç«™ä¼š
- æ˜¨æ—¥å®Œæˆçš„ä»»åŠ¡
- ä»Šæ—¥è®¡åˆ’çš„ä»»åŠ¡
- é‡åˆ°çš„é˜»ç¢

### æ¯å‘¨å›é¡¾
- é‡Œç¨‹ç¢‘è¾¾æˆæƒ…å†µ
- é£é™©æ›´æ–°
- ä¸‹å‘¨è®¡åˆ’è°ƒæ•´

---

**æœ€åæ›´æ–°**: 2026-02-05
**å®¡æ‰¹çŠ¶æ€**: å¾…æ‰¹å‡†

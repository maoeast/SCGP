<template>
  <div class="sql-test">
    <h1>ç³»ç»Ÿæµ‹è¯•é¡µé¢</h1>

    <div class="test-sections">
      <div class="section">
        <h2>SQL.js æµ‹è¯•</h2>
        <button @click="testImport">æµ‹è¯•å¯¼å…¥</button>
        <button @click="testInit">æµ‹è¯•åˆå§‹åŒ–</button>
      </div>

      <div class="section">
        <h2>å™¨æè®­ç»ƒæ¨¡å—æµ‹è¯•</h2>
        <button @click="testEquipmentAPI" :disabled="testing.equipment">
          {{ testing.equipment ? 'æµ‹è¯•ä¸­...' : 'æµ‹è¯•å™¨æAPI' }}
        </button>
        <button @click="testEquipmentTraining" :disabled="testing.training">
          {{ testing.training ? 'æµ‹è¯•ä¸­...' : 'æµ‹è¯•è®­ç»ƒè®°å½•' }}
        </button>
        <button @click="testIEPGenerator" :disabled="testing.iep">
          {{ testing.iep ? 'æµ‹è¯•ä¸­...' : 'æµ‹è¯•IEPç”Ÿæˆ' }}
        </button>
        <button @click="generateTestData" :disabled="testing.data">
          {{ testing.data ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆæµ‹è¯•æ•°æ®' }}
        </button>
      </div>

      <div class="section">
        <h2>æ•°æ®åº“æ“ä½œ</h2>
        <button @click="clearTestData">æ¸…ç©ºæµ‹è¯•æ•°æ®</button>
        <button @click="viewDatabaseStats">æ•°æ®åº“ç»Ÿè®¡</button>
      </div>
    </div>

    <div class="result-section">
      <h3>æµ‹è¯•ç»“æœ</h3>
      <pre>{{ testResult }}</pre>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue'
import { EquipmentAPI, EquipmentTrainingAPI, StudentAPI } from '@/database/api'
import { IEPGenerator } from '@/utils/iep-generator'
import { generateTestStudent, generateEquipmentTrainingRecords } from '@/database/equipment-test-data'
import { equipmentDataList } from '@/database/equipment-data'
import { ElMessage } from 'element-plus'

const testResult = ref('ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...')
const testing = reactive({
  equipment: false,
  training: false,
  iep: false,
  data: false
})

// ========== SQL.js æµ‹è¯• ==========

async function testImport() {
  testResult.value = 'æ­£åœ¨æµ‹è¯•å¯¼å…¥...\n'

  try {
    // æµ‹è¯•1: ç›´æ¥å¯¼å…¥
    testResult.value += '\n1. å°è¯•ç›´æ¥å¯¼å…¥ sql.js...\n'
    const sqljs = await import('sql.js')
    testResult.value += `æ¨¡å—å¯¹è±¡: ${JSON.stringify(Object.keys(sqljs), null, 2)}\n`
    testResult.value += `default ç±»å‹: ${typeof sqljs.default}\n`
    testResult.value += `default æ˜¯å¦ä¸ºå‡½æ•°: ${typeof sqljs.default === 'function'}\n`

    // æµ‹è¯•2: æ£€æŸ¥æ¨¡å—å†…å®¹
    testResult.value += '\n2. æ£€æŸ¥æ¨¡å—æ‰€æœ‰å±æ€§...\n'
    for (const key in sqljs) {
      const value = (sqljs as any)[key]
      testResult.value += `${key}: ${typeof value} ${typeof value === 'function' ? '(å‡½æ•°)' : ''}\n`
    }

    // æµ‹è¯•3: å°è¯•ç›´æ¥å¯¼å…¥sql-wasm
    testResult.value += '\n3. å°è¯•ç›´æ¥å¯¼å…¥ sql-wasm.js...\n'
    try {
      const sqlWasm = await import('sql.js/dist/sql-wasm.js')
      testResult.value += `sql-wasm å¯¼å‡º: ${JSON.stringify(Object.keys(sqlWasm), null, 2)}\n`
    } catch (e: any) {
      testResult.value += `sql-wasm å¯¼å…¥å¤±è´¥: ${e.message}\n`
    }

    // æµ‹è¯•4: æ£€æŸ¥å…¨å±€å¯¹è±¡
    testResult.value += '\n4. æ£€æŸ¥å…¨å±€å¯¹è±¡...\n'
    testResult.value += `window.initSqlJs: ${typeof (window as any).initSqlJs}\n`
    testResult.value += `window.SQL: ${typeof (window as any).SQL}\n`

  } catch (error: any) {
    testResult.value += `\né”™è¯¯: ${error.message}\n`
    testResult.value += `é”™è¯¯å †æ ˆ: ${error.stack}\n`
  }
}

async function testInit() {
  testResult.value = 'æ­£åœ¨æµ‹è¯•åˆå§‹åŒ–...\n'

  try {
    // ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰å‘ç°çš„åŠ è½½æ–¹å¼
    testResult.value += '\n1. å°è¯•åŠ¨æ€åˆ›å»ºscriptæ ‡ç­¾...\n'

    const initSqlJs = await new Promise((resolve, reject) => {
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
      if ((window as any).initSqlJs) {
        resolve((window as any).initSqlJs)
        return
      }

      const script = document.createElement('script')
      script.src = '/node_modules/sql.js/dist/sql-wasm.js'
      script.onload = () => {
        if ((window as any).initSqlJs) {
          resolve((window as any).initSqlJs)
        } else {
          reject(new Error('initSqlJs not found'))
        }
      }
      script.onerror = reject
      document.head.appendChild(script)
    })

    testResult.value += `æˆåŠŸåŠ è½½ initSqlJs: ${typeof initSqlJs}\n`

    // å°è¯•åˆå§‹åŒ–
    testResult.value += '\n2. å°è¯•åˆå§‹åŒ–æ•°æ®åº“...\n'
    const SQL = await initSqlJs({
      locateFile: file => `/node_modules/sql.js/dist/${file}`
    })

    testResult.value += `æ•°æ®åº“å¯¹è±¡ç±»å‹: ${typeof SQL}\n`
    testResult.value += 'åˆ›å»ºæµ‹è¯•æ•°æ®åº“...\n'

    const db = new SQL.Database()
    db.run('CREATE TABLE test (id INTEGER, name TEXT)')
    db.run('INSERT INTO test (id, name) VALUES (1, "Hello SQL.js")')

    const result = db.exec('SELECT * FROM test')
    testResult.value += `\næŸ¥è¯¢ç»“æœ: ${JSON.stringify(result, null, 2)}\n`

    testResult.value += '\nâœ… SQL.js æµ‹è¯•æˆåŠŸï¼'
  } catch (error: any) {
    testResult.value += `\nâŒ é”™è¯¯: ${error.message}\n`
    testResult.value += `é”™è¯¯å †æ ˆ: ${error.stack}\n`
  }
}

// ========== å™¨æè®­ç»ƒæ¨¡å—æµ‹è¯• ==========

async function testEquipmentAPI() {
  testing.equipment = true
  testResult.value = 'æ­£åœ¨æµ‹è¯•å™¨æAPI...\n'

  try {
    const api = new EquipmentAPI()

    testResult.value += '\n1. è·å–æ‰€æœ‰å™¨æ...\n'
      const cat = eq.category
      categoryCounts[cat] = (categoryCounts[cat] || 0) + 1
    })
    testResult.value += `âœ… åˆ†ç±»ç»Ÿè®¡: ${JSON.stringify(categoryCounts, null, 2)}\n`

    testResult.value += '\n4. æœç´¢å™¨æ...\n'
    const searchResults = api.getEquipment({ keyword: 'çƒ' })
    testResult.value += `âœ… æœç´¢"çƒ"çš„ç»“æœ: ${searchResults.length}ä¸ª\n`

    testResult.value += '\nâœ… å™¨æAPIæµ‹è¯•å®Œæˆï¼'
  } catch (error: any) {
    testResult.value += `\nâŒ é”™è¯¯: ${error.message}\n`
  } finally {
    testing.equipment = false
  }
}

async function testEquipmentTraining() {
  testing.training = true
  testResult.value = 'æ­£åœ¨æµ‹è¯•è®­ç»ƒè®°å½•API...\n'

  try {
    const api = new EquipmentTrainingAPI()
    const studentAPI = new StudentAPI()

    // è·å–ç¬¬ä¸€ä¸ªå­¦ç”Ÿ
    const students = await studentAPI.getAllStudents()
    if (students.length === 0) {
      testResult.value = 'âš ï¸ æ²¡æœ‰å­¦ç”Ÿæ•°æ®ï¼Œè¯·å…ˆåˆ›å»ºå­¦ç”Ÿ\n'
      testing.training = false
      return
    }

    const student = students[0]
    testResult.value += `ä½¿ç”¨æµ‹è¯•å­¦ç”Ÿ: ${student.name}\n`

    // è·å–å™¨æåˆ—è¡¨
    const equipmentAPI = new EquipmentAPI()
    const equipment = equipmentAPI.getAllEquipment()
    if (equipment.length === 0) {
      testResult.value = 'âš ï¸ æ²¡æœ‰å™¨ææ•°æ®\n'
      testing.training = false
      return
    }

    testResult.value += `\n1. åˆ›å»ºè®­ç»ƒè®°å½•...\n`
    const recordId = api.createRecord({
      student_id: student.id,
      equipment_id: equipment[0].id,
      score: 4,
      prompt_level: 2,
      duration_seconds: 600,
      notes: 'æµ‹è¯•è®°å½•',
      training_date: new Date().toISOString()
    })
    testResult.value += `âœ… åˆ›å»ºè®°å½• ID: ${recordId}\n`

    testResult.value += `\n2. è·å–å­¦ç”Ÿè®­ç»ƒè®°å½•...\n`
    const records = api.getStudentRecords(student.id)
    testResult.value += `âœ… è®°å½•æ€»æ•°: ${records.length}\n`

    testResult.value += `\n3. è·å–ä¸Šæ¬¡è®°å½•...\n`
    const lastRecord = api.getLastRecord(student.id, equipment[0].id)
    testResult.value += `âœ… ä¸Šæ¬¡è®°å½•: ${lastRecord ? `${lastRecord.score}åˆ†` : 'æ— '}\n`

    testResult.value += `\n4. è·å–ç»Ÿè®¡æ•°æ®...\n`
    const stats = api.getTrainingStats(student.id)
    testResult.value += `âœ… ç»Ÿè®¡æ•°æ®: ${JSON.stringify(stats, null, 2)}\n`

    testResult.value += '\nâœ… è®­ç»ƒè®°å½•APIæµ‹è¯•å®Œæˆï¼'
  } catch (error: any) {
    testResult.value += `\nâŒ é”™è¯¯: ${error.message}\n`
  } finally {
    testing.training = false
  }
}

async function testIEPGenerator() {
  testing.iep = true
  testResult.value = 'æ­£åœ¨æµ‹è¯•IEPç”Ÿæˆå™¨...\n'

  try {
    testResult.value += '\n1. ç”Ÿæˆå™¨æè®­ç»ƒIEPæŠ¥å‘Š...\n'

    const report = IEPGenerator.generateEquipmentReport({
      studentName: 'æµ‹è¯•å­¦ç”Ÿ',
      equipment: {
        id: 1,
        name: 'è§¦è§‰çƒ',
        category: 'tactile',
        sub_category: 'åŸºç¡€è§¦è§‰',
        description: 'ç”¨äºè§¦è§‰åˆºæ¿€è®­ç»ƒ',
        ability_tags: ['è§¦è§‰æ„ŸçŸ¥', 'æ‰‹çœ¼åè°ƒ']
      },
      score: 4,
      promptLevel: 2,
      duration_seconds: 600,
      training_date: new Date().toISOString(),
      notes: 'è¡¨ç°è‰¯å¥½'
    })

    testResult.value += `\nâœ… æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼\n`
    testResult.value += `\nå­¦ç”Ÿ: ${report.studentName}\n`
    testResult.value += `å™¨æ: ${report.equipmentName}\n`
    testResult.value += `é¢†åŸŸ: ${report.domainName}\n`
    testResult.value += `æ—¥æœŸ: ${report.reportDate}\n`

    testResult.value += `\n2. è¡¨ç°è¯„ä¼°:\n${report.performance}\n`

    testResult.value += `\n3. è®­ç»ƒå»ºè®®:\n${report.suggestions.map(s => `  â€¢ ${s}`).join('\n')}\n`

    testResult.value += `\n4. å®Œæ•´è¯„è¯­:\n${report.generatedComment}\n`

    testResult.value += '\nâœ… IEPç”Ÿæˆå™¨æµ‹è¯•å®Œæˆï¼'
  } catch (error: any) {
    testResult.value += `\nâŒ é”™è¯¯: ${error.message}\n`
    testResult.value += `é”™è¯¯å †æ ˆ: ${error.stack}\n`
  } finally {
    testing.iep = false
  }
}

async function generateTestData() {
  testing.data = true
  testResult.value = 'æ­£åœ¨ç”Ÿæˆæµ‹è¯•æ•°æ®...\n'

  try {
    const studentAPI = new StudentAPI()
    const trainingAPI = new EquipmentTrainingAPI()
    const equipmentAPI = new EquipmentAPI()

    // ç”Ÿæˆå­¦ç”Ÿ
    testResult.value += '\n1. ç”Ÿæˆæµ‹è¯•å­¦ç”Ÿ...\n'
    const students = generateTestStudent(3)
    const studentIds: number[] = []

    for (const student of students) {
      const id = await studentAPI.addStudent(student)
      studentIds.push(id)
      testResult.value += `âœ… åˆ›å»ºå­¦ç”Ÿ: ${student.name} (ID: ${id})\n`
    }

    // è·å–å™¨æ
    testResult.value += '\n2. è·å–å™¨æåˆ—è¡¨...\n'
    const equipment = equipmentAPI.getAllEquipment()
    testResult.value += `âœ… å¯ç”¨å™¨æ: ${equipment.length}ä¸ª\n`

    // ç”Ÿæˆè®­ç»ƒè®°å½•
    testResult.value += '\n3. ç”Ÿæˆè®­ç»ƒè®°å½•...\n'
    let totalRecords = 0

    studentIds.forEach(studentId => {
      const records = generateEquipmentTrainingRecords(studentId, equipment, 5)
      records.forEach(record => {
        trainingAPI.createRecord(record)
        totalRecords++
      })
    })

    testResult.value += `âœ… åˆ›å»ºè®­ç»ƒè®°å½•: ${totalRecords}æ¡\n`

    testResult.value += '\nâœ… æµ‹è¯•æ•°æ®ç”Ÿæˆå®Œæˆï¼'
    ElMessage.success('æµ‹è¯•æ•°æ®ç”ŸæˆæˆåŠŸ')
  } catch (error: any) {
    testResult.value += `\nâŒ é”™è¯¯: ${error.message}\n`
    ElMessage.error('ç”Ÿæˆå¤±è´¥: ' + error.message)
  } finally {
    testing.data = false
  }
}

function clearTestData() {
  testResult.value = 'æ¸…ç©ºæµ‹è¯•æ•°æ®åŠŸèƒ½...\n\n'
  testResult.value += 'æç¤º: æ­¤åŠŸèƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡ŒSQLåˆ é™¤æµ‹è¯•æ•°æ®\n'
  testResult.value += 'å»ºè®®åˆ é™¤æ¡ä»¶:\n'
  testResult.value += '- å­¦ç”Ÿå§“ååŒ…å«"æµ‹è¯•"\n'
  testResult.value += '- å­¦å·ä»¥"TEST"å¼€å¤´\n'
}

async function viewDatabaseStats() {
  testResult.value = 'æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯...\n\n'

  try {
    const studentAPI = new StudentAPI()
    const equipmentAPI = new EquipmentAPI()
    const trainingAPI = new EquipmentTrainingAPI()

    testResult.value += '========== æ•°æ®åº“ç»Ÿè®¡ ==========\n\n'

    const students = await studentAPI.getAllStudents()
    testResult.value += `ğŸ“Š å­¦ç”Ÿæ€»æ•°: ${students.length}\n`

    const equipment = equipmentAPI.getAllEquipment()
    testResult.value += `ğŸ“Š å™¨ææ€»æ•°: ${equipment.length}\n`

    const counts = equipmentAPI.getCategoryCounts()
    testResult.value += '\nå™¨æåˆ†ç±»ç»Ÿè®¡:\n'
    Object.entries(counts).forEach(([cat, count]) => {
      testResult.value += `  ${cat}: ${count}ä¸ª\n`
    })

    testResult.value += '\nè®­ç»ƒè®°å½•ç»Ÿè®¡:\n'
    students.forEach(student => {
      const records = trainingAPI.getStudentRecords(student.id)
      if (records.length > 0) {
        testResult.value += `  ${student.name}: ${records.length}æ¡è®°å½•\n`
      }
    })

    testResult.value += '\n================================\n'
  } catch (error: any) {
    testResult.value += `\nâŒ é”™è¯¯: ${error.message}\n`
  }
}
</script>

<style scoped>
.sql-test {
  padding: 20px;
  max-width: 1000px;
  margin: 0 auto;
}

.test-sections {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.section {
  padding: 15px;
  background: #f5f7fa;
  border-radius: 8px;
}

.section h2 {
  margin-top: 0;
  margin-bottom: 15px;
  font-size: 16px;
  color: #303133;
}

.result-section {
  margin-top: 20px;
}

.result-section h3 {
  margin-bottom: 10px;
  color: #303133;
}

pre {
  background: #1e1e1e;
  color: #d4d4d4;
  padding: 15px;
  border-radius: 5px;
  white-space: pre-wrap;
  word-wrap: break-word;
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.5;
  max-height: 400px;
  overflow-y: auto;
}

button {
  margin: 5px;
  padding: 8px 16px;
  background: #409eff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

button:hover:not(:disabled) {
  background: #66b1ff;
}

button:disabled {
  background: #c0c4cc;
  cursor: not-allowed;
}
</style>
<!--
  @deprecated
  æ­¤æ–‡ä»¶å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ç»Ÿä¸€çš„è¯„ä¼°å®¹å™¨ AssessmentContainer.vue

  æ–°è·¯ç”±: /assessment/unified/sm/:studentId
  é©±åŠ¨å™¨: src/strategies/assessment/SMDriver.ts

  Phase 4 é‡æ„ï¼šè¯„ä¼°æ¨¡å—å·²è¿ç§»åˆ°"UI å®¹å™¨å¤ç”¨ + ç­–ç•¥é©±åŠ¨å™¨"æ¶æ„ã€‚
  æ­¤æ–‡ä»¶ä»…ä½œä¸ºå†å²å‚è€ƒä¿ç•™ï¼Œä¸åº”å†è¢«è·¯ç”±å¼•ç”¨ã€‚

  è¿ç§»æ—¥æœŸ: 2026-02-24
-->
<template>
  <div class="sm-assessment">
    <!-- æ¸©é¦¨æç¤ºå¯¹è¯æ¡† -->
    <el-dialog
      v-model="showWelcomeDialog"
      title=""
      width="520px"
      append-to-body
      :close-on-click-modal="false"
      :close-on-press-escape="false"
      :show-close="false"
      class="welcome-dialog"
      draggable
    >
      <div class="welcome-content">
        <p class="welcome-intro">åœ¨å¡«å†™è¿™ä»½é‡è¡¨å‰ï¼Œè¯·æ‚¨æ”¾è½»æ¾ã€‚è¿™ä¸ä»…æ˜¯ä¸€æ¬¡è¯„ä¼°ï¼Œæ›´æ˜¯æˆ‘ä»¬å…±åŒäº†è§£å­©å­"ç”Ÿæ´»æ™ºæ…§"çš„è¿‡ç¨‹ã€‚</p>

        <div class="welcome-sections">
          <div class="welcome-section">
            <h4><span class="section-icon">ğŸ </span> è¿™ä¸æ˜¯è€ƒè¯•ï¼Œæ— å…³æˆç»©</h4>
            <p>æˆ‘ä»¬å…³æ³¨çš„æ˜¯å­©å­åœ¨ç”Ÿæ´»ä¸­å¦‚ä½•ç…§é¡¾è‡ªå·±ã€å¦‚ä½•ä¸äººäº¤å¾€ï¼Œè¿™ä¸å¹¼å„¿å›­æˆ–å­¦æ ¡çš„æ–‡åŒ–è¯¾æˆç»©å®Œå…¨æ— å…³ã€‚</p>
          </div>

          <div class="welcome-section">
            <h4><span class="section-icon">ğŸŒ±</span> æ¥çº³å·®å¼‚ï¼Œå…è®¸"ä¸ä¼š"</h4>
            <p>é‡è¡¨æ¶µç›–äº†ä»å©´å„¿åˆ°åˆä¸­ç”Ÿçš„å¹¿æ³›å†…å®¹ã€‚å¦‚æœæ‚¨çš„å­©å­æœ‰äº›é¡¹ç›®è¿˜ä¸ä¼šåšï¼Œè¿™æ˜¯éå¸¸æ­£å¸¸çš„ï¼Œå› ä¸ºæ¯ä¸ªå­©å­çš„å¹´é¾„å’Œæˆé•¿èŠ‚å¥éƒ½ä¸åŒã€‚</p>
          </div>

          <div class="welcome-section">
            <h4><span class="section-icon">ğŸ‘©â€ğŸ«</span> è°æ¥å¡«å†™æœ€åˆé€‚ï¼Ÿ</h4>
            <p>è¯·ç”±æ¯å¤©é™ªä¼´å­©å­ã€æœ€äº†è§£å­©å­æ—¥å¸¸èµ·å±…çš„äººï¼ˆå¦‚çˆ¶æ¯ã€ä¸»è¦æŠšå…»äººæˆ–ç»å¸¸ä¸å­©å­æ¥è§¦çš„è€å¸ˆï¼‰æ¥å›ç­”ã€‚</p>
          </div>

          <div class="welcome-section">
            <h4><span class="section-icon">ğŸ’–</span> çœŸå®æ˜¯æœ€å¤§çš„å¸®åŠ©</h4>
            <p>è¯·ä¾æ®å­©å­å¹³æ—¶çš„å®é™…è¡¨ç°ï¼ˆè€Œé"ä»–åº”è¯¥ä¼š"æˆ–"å¶å°”ä¼š"ï¼‰å¦ç‡å›ç­”ã€‚æ‚¨çœŸå®çš„åé¦ˆï¼Œæ˜¯æˆ‘ä»¬ä¸ºå­©å­æä¾›ä¸ªæ€§åŒ–æ”¯æŒçš„åŸºçŸ³ã€‚</p>
          </div>
        </div>

        <p class="welcome-footer">æ„Ÿè°¢æ‚¨çš„çœŸè¯šä¸åˆä½œï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ”¯æŒå­©å­æ›´å¥½åœ°é€‚åº”ç”Ÿæ´»ï¼</p>
      </div>
      <template #footer>
        <div class="dialog-footer">
          <el-button type="primary" @click="startAssessment">
            æˆ‘å·²äº†è§£ï¼Œå¼€å§‹è¯„ä¼°
          </el-button>
        </div>
      </template>
    </el-dialog>

    <!-- è¯„ä¼°å¤´éƒ¨ -->
    <el-card class="assessment-header">
      <template #header>
        <div class="header-content">
          <div class="student-info">
            <h3>S-Mé‡è¡¨è¯„ä¼°</h3>
            <div class="info-row">
              <span>å­¦ç”Ÿï¼š{{ student?.name }}</span>
              <span>å¹´é¾„ï¼š{{ studentAge }}å²</span>
              <span>èµ·å§‹é˜¶æ®µï¼šç¬¬ {{ currentAgeStage?.stage }} é˜¶æ®µ</span>
              <span v-if="currentAssessStage">å½“å‰è¯„ä¼°ï¼š{{ currentAssessStage }}</span>
            </div>
          </div>
          <div class="progress-info">
            <el-progress
              :percentage="progressPercentage"
              :format="progressFormat"
              :stroke-width="20"
            />
            <div class="progress-text">
              å·²å®Œæˆï¼š{{ currentIndex + 1 }} / {{ totalQuestions }}
            </div>
          </div>
        </div>
      </template>
    </el-card>

    <!-- é¢˜ç›®å¡ç‰‡ -->
    <el-card class="question-card" v-if="currentQuestion">
      <template #header>
        <div class="question-header">
          <span class="question-number">ç¬¬ {{ currentIndex + 1 }} é¢˜ (é¢˜å·:{{ currentQuestion.id }})</span>
          <span class="question-stage">{{ currentAssessStage }}</span>
          <span class="question-dimension">{{ currentQuestion.dimension }}</span>
        </div>
      </template>

      <div class="question-content">
        <div class="question-title">
          {{ currentQuestion.title }}
        </div>

        <!-- è¯­éŸ³æ’­æ”¾æŒ‰é’® -->
        <div class="question-actions">
          <el-button
            type="info"
            :icon="Microphone"
            @click="playAudio"
            :loading="isPlaying"
          >
            {{ isPlaying ? 'æ’­æ”¾ä¸­...' : 'æœ—è¯»é¢˜ç›®' }}
          </el-button>
        </div>

        <!-- ç­”æ¡ˆé€‰é¡¹ -->
        <div class="answer-options">
          <el-radio-group v-model="currentAnswer" @change="handleAnswer">
            <el-radio :value="1" size="large">
              <span class="option-label">é€šè¿‡</span>
              <span class="option-desc">å­¦ç”Ÿèƒ½å¤Ÿå®Œæˆè¯¥é¡¹èƒ½åŠ›</span>
            </el-radio>
            <el-radio :value="0" size="large">
              <span class="option-label">ä¸é€šè¿‡</span>
              <span class="option-desc">å­¦ç”Ÿä¸èƒ½å®Œæˆè¯¥é¡¹èƒ½åŠ›</span>
            </el-radio>
          </el-radio-group>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="question-footer">
        <el-button
          :disabled="currentIndex === 0"
          @click="previousQuestion"
        >
          ä¸Šä¸€é¢˜
        </el-button>
        <!-- ç§»é™¤"ä¸‹ä¸€é¢˜"æŒ‰é’®ï¼Œé€‰æ‹©ç­”æ¡ˆåè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜ -->
      </div>
    </el-card>

    <!-- è¯„ä¼°å®Œæˆå¯¹è¯æ¡† -->
    <el-dialog
      v-model="showCompleteDialog"
      title="è¯„ä¼°å®Œæˆ"
      width="500px"
      append-to-body
      :close-on-click-modal="false"
      :close-on-press-escape="false"
      :show-close="false"
    >
      <div class="complete-content">
        <el-icon class="success-icon" color="#67C23A" size="60"><CircleCheck /></el-icon>
        <h3>è¯„ä¼°å·²å®Œæˆï¼</h3>
        <p>ç³»ç»Ÿæ­£åœ¨è®¡ç®—è¯„ä¼°ç»“æœ...</p>
      </div>
      <template #footer>
        <el-button @click="saveAndExit">ä¿å­˜å¹¶é€€å‡º</el-button>
        <el-button type="primary" @click="viewReport">æŸ¥çœ‹æŠ¥å‘Š</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, onBeforeUnmount } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import {
  Microphone,
  CircleCheck,
  InfoFilled
} from '@element-plus/icons-vue'
import { useStudentStore } from '@/stores/student'
import { SMAssessmentAPI, ReportAPI } from '@/database/api'

const router = useRouter()
const route = useRoute()
const studentStore = useStudentStore()

// æ¸©é¦¨æç¤ºå¯¹è¯æ¡†
const showWelcomeDialog = ref(true)

// å“åº”å¼é‡è¡¨æ•°æ®
const smQuestions = ref<any[]>([])
const smAgeRanges = ref<any[]>([])
const calculateSQScore = ref<any>(null)
const getEvaluationLevel = ref<any>(null)

// å­¦ç”Ÿä¿¡æ¯
const studentId = ref(route.query.studentId as string)
const student = computed(() =>
  studentStore.students.find(s => s.id === parseInt(studentId.value))
)

// å­¦ç”Ÿæœˆé¾„
const studentAgeInMonths = computed(() => {
  if (!student.value?.birthday) return 0
  const birth = new Date(student.value.birthday)
  const today = new Date()

  // è®¡ç®—æ€»æœˆæ•°
  let months = (today.getFullYear() - birth.getFullYear()) * 12
  months += today.getMonth() - birth.getMonth()

  // å¦‚æœå½“æœˆå¤©æ•°å°äºå‡ºç”Ÿå¤©æ•°ï¼Œå‡å»ä¸€ä¸ªæœˆ
  if (today.getDate() < birth.getDate()) {
    months--
  }

  return months
})

// å­¦ç”Ÿå¹´é¾„ï¼ˆå‘¨å²ï¼‰
const studentAge = computed(() => {
  return Math.floor(studentAgeInMonths.value / 12)
})

// å½“å‰å¹´é¾„é˜¶æ®µ
const currentAgeStage = computed(() => {
  // æ ¹æ®æœˆé¾„è·å–å¯¹åº”çš„ age_stage
  let ageStage = 0
  if (studentAgeInMonths.value >= 0 && studentAgeInMonths.value <= 23) ageStage = 1
  else if (studentAgeInMonths.value >= 24 && studentAgeInMonths.value <= 41) ageStage = 2
  else if (studentAgeInMonths.value >= 42 && studentAgeInMonths.value <= 59) ageStage = 3
  else if (studentAgeInMonths.value >= 60 && studentAgeInMonths.value <= 77) ageStage = 4
  else if (studentAgeInMonths.value >= 78 && studentAgeInMonths.value <= 101) ageStage = 5
  else if (studentAgeInMonths.value >= 102 && studentAgeInMonths.value <= 125) ageStage = 6
  else if (studentAgeInMonths.value >= 126) ageStage = 7

  return { stage: ageStage }
})

// è·å–è¯„ä¼°é¢˜ç›®ï¼ˆåŒ…å«æ‰€æœ‰é˜¶æ®µä»¥æ”¯æŒå‘å‰å‘åè¯„ä¼°ï¼‰
const filteredQuestions = computed(() => {
  if (!currentAgeStage.value || !smQuestions.value) return []

  // åŒ…å«æ‰€æœ‰é˜¶æ®µçš„é¢˜ç›®ï¼Œä»¥æ”¯æŒå‘å‰æŸ¥æ‰¾
  return smQuestions.value.sort((a, b) => a.id - b.id)
})

// è·å–èµ·å§‹å¹´é¾„é˜¶æ®µåœ¨é¢˜ç›®åˆ—è¡¨ä¸­çš„ç´¢å¼•ä½ç½®
const ageStageStartIndex = computed(() => {
  if (!currentAgeStage.value || !filteredQuestions.value.length) return 0

  // æ‰¾åˆ°å½“å‰å¹´é¾„é˜¶æ®µçš„ç¬¬ä¸€ä¸ªé¢˜ç›®çš„ç´¢å¼•
  const index = filteredQuestions.value.findIndex(
    q => q.age_stage === currentAgeStage.value!.stage
  )
  return index !== -1 ? index : 0
})

// é¢˜ç›®ç›¸å…³çŠ¶æ€
const currentIndex = ref(0)
const totalQuestions = computed(() => filteredQuestions.value.length)
const currentQuestion = computed(() => filteredQuestions.value[currentIndex.value])
const progressPercentage = computed(() => {
  if (totalQuestions.value === 0) return 0

  // æ˜¾ç¤ºåŸºäºå½“å‰å·²è¯„ä¼°é¢˜ç›®çš„è¿›åº¦
  const evaluatedCount = currentIndex.value + 1
  return Math.round((evaluatedCount / Math.max(evaluatedCount, totalQuestions.value)) * 100)
})

// å½“å‰è¯„ä¼°çš„é˜¶æ®µ
const currentAssessStage = computed(() => {
  if (!currentQuestion.value) return null
  return `ç¬¬${currentQuestion.value.age_stage}é˜¶æ®µ`
})

// ç­”æ¡ˆå­˜å‚¨
const answers = ref<Record<number, number>>({})
const currentAnswer = ref<number | null>(null)
const justNavigated = ref(false)  // æ ‡è®°æ˜¯å¦åˆšåˆšè¿›è¡Œäº†å¯¼èˆªï¼ˆç”¨äºåŒºåˆ†ä¸»åŠ¨ä¿®æ”¹å’Œé‡æ–°ç¡®è®¤ï¼‰

// åŸºçº¿ï¼ˆBasalï¼‰å’Œä¸Šé™ï¼ˆCeilingï¼‰ç®¡ç†
const basalEstablished = ref(false)  // æ˜¯å¦å·²å»ºç«‹åŸºçº¿ï¼ˆè¿ç»­10é¡¹å…¨é€šè¿‡ï¼‰
const visitedStages = ref<Set<number>>(new Set())  // å·²è®¿é—®è¿‡çš„é˜¶æ®µï¼Œé¿å…é‡å¤å›é€€
const basalStage = ref<number | null>(null)  // åŸºçº¿æ‰€åœ¨é˜¶æ®µ

// è¯­éŸ³æ’­æ”¾çŠ¶æ€
const isPlaying = ref(false)
let speechSynthesis: SpeechSynthesis | null = null
let currentUtterance: SpeechSynthesisUtterance | null = null

// å®Œæˆå¯¹è¯æ¡†
const showCompleteDialog = ref(false)
const assessId = ref<number | null>(null)

// è¿›åº¦æ ¼å¼åŒ–
const progressFormat = (percentage: number) => `${percentage}%`

// å¤„ç†ç­”æ¡ˆ
const handleAnswer = (value: number) => {
  if (currentQuestion.value) {
    const questionId = currentQuestion.value.id
    const previousAnswer = answers.value[questionId]
    const wasNavigated = justNavigated.value

    console.log(`ğŸ¯ handleAnswer è°ƒç”¨ - é¢˜ç›®${questionId}, æ–°å€¼:${value}, æ—§å€¼:${previousAnswer}, justNavigated:${wasNavigated}`)

    // ğŸ”‘ ç«‹å³é‡ç½®å¯¼èˆªæ ‡è®°ï¼ˆåœ¨åšä»»ä½•åˆ¤æ–­ä¹‹å‰ï¼‰
    if (justNavigated.value) {
      justNavigated.value = false
      console.log(`  ğŸ”„ é‡ç½® justNavigated æ ‡è®°`)
    }

    // ğŸ”‘ å…³é”®åˆ¤æ–­ï¼šåŒºåˆ†ä¸¤ç§æƒ…å†µ
    // 1. é¦–æ¬¡å›ç­”æˆ–å¯¼èˆªåé‡æ–°é€‰æ‹© -> å…è®¸ç»§ç»­
    // 2. ä¸»åŠ¨è¿”å›ä¿®æ”¹ç­”æ¡ˆ -> æç¤ºå·²æ›´æ–°ï¼Œä¸è‡ªåŠ¨è·³è½¬

    if (previousAnswer !== undefined && !wasNavigated) {
      // ä¸»åŠ¨è¿”å›å·²å›ç­”é¢˜ç›®ä¿®æ”¹ç­”æ¡ˆ
      if (previousAnswer !== value) {
        // ä¿®æ”¹äº†ç­”æ¡ˆ
        answers.value[questionId] = value
        saveProgress()
        console.log(`  â›” ä¸»åŠ¨ä¿®æ”¹ç­”æ¡ˆï¼Œé˜»æ­¢è‡ªåŠ¨è·³è½¬`)
        ElMessage.success('ç­”æ¡ˆå·²æ›´æ–°')
        return
      } else {
        // ç‚¹å‡»ç›¸åŒç­”æ¡ˆï¼Œä¸åšä»»ä½•å¤„ç†
        console.log(`  âš ï¸ é‡å¤ç‚¹å‡»ç›¸åŒç­”æ¡ˆï¼Œé˜»æ­¢è‡ªåŠ¨è·³è½¬`)
        return
      }
    }

    // é¦–æ¬¡å›ç­”æˆ–å¯¼èˆªåé‡æ–°é€‰æ‹©ï¼Œå…è®¸ç»§ç»­
    console.log(`  âœ… å…è®¸ç»§ç»­`)
    answers.value[questionId] = value
    saveProgress()

    // ç›´æ¥è¿›å…¥ä¸‹ä¸€é¢˜
    console.log(`  â­ï¸ å‡†å¤‡è¿›å…¥ä¸‹ä¸€é¢˜...`)
    setTimeout(() => {
      nextQuestion()
    }, 200) // å»¶è¿Ÿ200msè®©ç”¨æˆ·çœ‹åˆ°é€‰æ‹©æ•ˆæœ
  }
}

// ä¸Šä¸€é¢˜
const previousQuestion = () => {
  if (currentIndex.value > 0) {
    currentIndex.value--
    // ğŸ”‘ ä¸é¢„å…ˆé€‰ä¸­ç­”æ¡ˆï¼Œè®©ç”¨æˆ·é‡æ–°é€‰æ‹©
    currentAnswer.value = null
    justNavigated.value = true  // æ ‡è®°ä¸ºå¯¼èˆª
    console.log('â¬…ï¸ è¿”å›ä¸Šä¸€é¢˜ï¼Œæ¸…ç©ºç­”æ¡ˆé€‰æ‹©')
  }
}

// æ£€æŸ¥æ˜¯å¦åº”è¯¥ç»“æŸè¯„ä¼°ï¼ˆS-Mè§„åˆ™ï¼šè¿ç»­10é¡¹é€šè¿‡å’Œ10é¡¹ä¸é€šè¿‡ï¼‰
const shouldEndAssessment = (currentAnswers: Record<number, number>): boolean => {
  if (!smQuestions.value || !currentAgeStage.value) return false

  const allQuestions = smQuestions.value.sort((a, b) => a.id - b.id)
  const startIndex = ageStageStartIndex.value

  let tenPassStartIndex = -1  // è¿ç»­10é¡¹é€šè¿‡å¼€å§‹çš„ä½ç½®
  let tenPassEndIndex = -1    // è¿ç»­10é¡¹é€šè¿‡ç»“æŸçš„ä½ç½®

  // Phase 1: ä»å¹´é¾„é˜¶æ®µèµ·å§‹ä½ç½®å‘å‰æœç´¢è¿ç»­10é¡¹é€šè¿‡
  let consecutivePass = 0
  for (let i = startIndex; i < allQuestions.length; i++) {
    const qid = allQuestions[i].id
    if (!currentAnswers.hasOwnProperty(qid)) break

    if (currentAnswers[qid] === 1) {
      consecutivePass++
      if (consecutivePass === 10) {
        tenPassStartIndex = i - 9
        tenPassEndIndex = i
        console.log('å‘å‰æœç´¢ï¼šå‘ç°è¿ç»­10é¡¹é€šè¿‡ï¼Œä»é¢˜ç›®', allQuestions[tenPassStartIndex].id, 'åˆ°', allQuestions[i].id)
        break
      }
    } else {
      consecutivePass = 0
    }
  }

  // Phase 2: å¦‚æœå‘å‰æ²¡æ‰¾åˆ°ï¼Œå°è¯•å‘åæœç´¢ï¼ˆé€‚ç”¨äºèµ·å§‹é˜¶æ®µé¢˜ç›®æœªå…¨é€šè¿‡çš„æƒ…å†µï¼‰
  if (tenPassStartIndex === -1 && startIndex > 0) {
    consecutivePass = 0
    // ä»èµ·å§‹ä½ç½®çš„å‰ä¸€é¢˜å¼€å§‹å‘åæœç´¢
    for (let i = startIndex - 1; i >= 0; i--) {
      const qid = allQuestions[i].id
      if (!currentAnswers.hasOwnProperty(qid)) {
        // é‡åˆ°æœªå›ç­”çš„é¢˜ç›®ï¼Œéœ€è¦ç»§ç»­è¯„ä¼°
        break
      }

      if (currentAnswers[qid] === 1) {
        consecutivePass++
        if (consecutivePass === 10) {
          tenPassStartIndex = i
          tenPassEndIndex = i + 9
          console.log('å‘åæœç´¢ï¼šå‘ç°è¿ç»­10é¡¹é€šè¿‡ï¼Œä»é¢˜ç›®', allQuestions[i].id, 'åˆ°', allQuestions[tenPassEndIndex].id)
          break
        }
      } else {
        consecutivePass = 0
      }
    }
  }

  // ğŸ”‘ å…³é”®ä¿®å¤ï¼šå¦‚æœæ²¡æœ‰æ‰¾åˆ°è¿ç»­10é¡¹é€šè¿‡ï¼Œæ£€æŸ¥æ˜¯å¦è¿ç»­10é¡¹ä¸é€šè¿‡
  // è¿™ç§æƒ…å†µä¸‹ï¼Œè¯„ä¼°ä¹Ÿåº”è¯¥ç»“æŸï¼ˆè¯´æ˜é¢˜ç›®å¤ªç®€å•ï¼Œå­¦ç”ŸåŸºç¡€èƒ½åŠ›è¾ƒä½ï¼‰
  if (tenPassStartIndex === -1) {
    // ä»èµ·å§‹ä½ç½®å¼€å§‹æ£€æŸ¥è¿ç»­ä¸é€šè¿‡
    let consecutiveFail = 0
    let answeredCount = 0

    for (let i = startIndex; i < allQuestions.length; i++) {
      const qid = allQuestions[i].id
      if (!currentAnswers.hasOwnProperty(qid)) break

      answeredCount++

      if (currentAnswers[qid] === 0) {
        consecutiveFail++
        console.log('é¢˜ç›®', qid, 'ä¸é€šè¿‡ï¼Œè¿ç»­ä¸é€šè¿‡æ•°:', consecutiveFail)

        if (consecutiveFail === 10) {
          console.log('S-Mè¯„ä¼°è§„åˆ™ï¼šæœªæ‰¾åˆ°åŸºçº¿ï¼Œä½†å‘ç°è¿ç»­10é¡¹ä¸é€šè¿‡ï¼Œè¯„ä¼°ç»“æŸ')
          ElMessage.info('æ ¹æ®S-Mè¯„ä¼°è§„åˆ™ï¼Œè¿ç»­10é¡¹ä¸é€šè¿‡ï¼Œè¯„ä¼°è‡ªåŠ¨ç»“æŸ')
          return true
        }
      } else {
        consecutiveFail = 0
        console.log('é¢˜ç›®', qid, 'é€šè¿‡ï¼Œé‡ç½®è¿ç»­ä¸é€šè¿‡è®¡æ•°')
      }
    }

    // å¦‚æœæ²¡æœ‰è¿ç»­10é¡¹ä¸é€šè¿‡ï¼Œè¯„ä¼°ç»§ç»­
    console.log('æœªæ‰¾åˆ°è¿ç»­10é¡¹é€šè¿‡ï¼Œä¹Ÿæœªæ‰¾åˆ°è¿ç»­10é¡¹ä¸é€šè¿‡ï¼Œè¯„ä¼°ç»§ç»­')
    return false
  }

  // Phase 3: ä»è¿ç»­10é¡¹é€šè¿‡ä¹‹åå¼€å§‹æ£€æŸ¥è¿ç»­10é¡¹ä¸é€šè¿‡
  let consecutiveFail = 0
  for (let i = tenPassEndIndex + 1; i < allQuestions.length; i++) {
    const qid = allQuestions[i].id
    if (!currentAnswers.hasOwnProperty(qid)) break

    if (currentAnswers[qid] === 0) {
      consecutiveFail++
      console.log('é¢˜ç›®', qid, 'ä¸é€šè¿‡ï¼Œè¿ç»­ä¸é€šè¿‡æ•°:', consecutiveFail)

      if (consecutiveFail === 10) {
        console.log('S-Mè¯„ä¼°è§„åˆ™ï¼šå‘ç°è¿ç»­10é¡¹ä¸é€šè¿‡ï¼Œè¯„ä¼°ç»“æŸ')
        ElMessage.info('æ ¹æ®S-Mè¯„ä¼°è§„åˆ™ï¼Œè¿ç»­10é¡¹ä¸é€šè¿‡ï¼Œè¯„ä¼°è‡ªåŠ¨ç»“æŸ')
        return true
      }
    } else {
      consecutiveFail = 0
      console.log('é¢˜ç›®', qid, 'é€šè¿‡ï¼Œé‡ç½®è¿ç»­ä¸é€šè¿‡è®¡æ•°')
    }
  }

  return false
}

// æ£€æŸ¥å½“å‰æ˜¯å¦å·²å»ºç«‹åŸºçº¿ï¼ˆè¿ç»­10é¡¹å…¨é€šè¿‡ï¼‰
const checkBasalEstablished = (): boolean => {
  if (!currentQuestion.value) return false

  const currentStage = currentQuestion.value.age_stage
  const stageQuestions = filteredQuestions.value.filter(q => q.age_stage === currentStage)

  // æ£€æŸ¥å½“å‰é˜¶æ®µæ˜¯å¦æ‰€æœ‰é¢˜ç›®éƒ½å·²å›ç­”ä¸”å…¨éƒ¨é€šè¿‡
  let allAnswered = true
  let allPassed = true

  for (const q of stageQuestions) {
    if (!answers.value.hasOwnProperty(q.id)) {
      allAnswered = false
      break
    }
    if (answers.value[q.id] !== 1) {
      allPassed = false
    }
  }

  // å¦‚æœå½“å‰é˜¶æ®µæ‰€æœ‰é¢˜ç›®éƒ½å›ç­”äº†ä¸”å…¨éƒ¨é€šè¿‡ï¼Œå»ºç«‹åŸºçº¿
  if (allAnswered && allPassed && stageQuestions.length >= 10) {
    console.log(`âœ… åŸºçº¿å·²å»ºç«‹ï¼šç¬¬${currentStage}é˜¶æ®µæ‰€æœ‰${stageQuestions.length}é¢˜å…¨éƒ¨é€šè¿‡`)
    basalEstablished.value = true
    basalStage.value = currentStage
    ElMessage.success({
      message: `åŸºçº¿å·²ç¡®ç«‹ï¼ç¬¬${currentStage}é˜¶æ®µå…¨éƒ¨é€šè¿‡ï¼Œç°åœ¨å¼€å§‹å‘å‰è¯„ä¼°`,
      duration: 3000
    })
    return true
  }

  return false
}

// æ£€æŸ¥æ˜¯å¦éœ€è¦å‘åå¯¼èˆªï¼ˆä»…åœ¨å»ºç«‹åŸºçº¿å‰è§¦å‘ï¼‰
const needsBackwardNavigation = (): boolean => {
  // ğŸ”‘ å…³é”®ï¼šå¦‚æœå·²ç»å»ºç«‹åŸºçº¿ï¼Œä¸å†å‘åå¯¼èˆª
  if (basalEstablished.value) {
    console.log('å·²å»ºç«‹åŸºçº¿ï¼Œä¸å†å‘åå¯¼èˆªï¼Œç»§ç»­å‘å‰å¯»æ‰¾ä¸Šé™')
    return false
  }

  const startIdx = ageStageStartIndex.value

  // å¦‚æœå·²ç»åœ¨èµ·å§‹é˜¶æ®µä¹‹å‰ï¼Œä¸éœ€è¦å†å¾€åå¯¼èˆª
  if (currentIndex.value < startIdx) {
    return false
  }

  // å¦‚æœèµ·å§‹é˜¶æ®µæ²¡æœ‰æ›´æ—©çš„é˜¶æ®µï¼Œä¸èƒ½å¾€åå¯¼èˆª
  if (startIdx <= 0) {
    return false
  }

  const currentStage = currentQuestion.value?.age_stage
  if (!currentStage) return false

  // ğŸ”‘ å…³é”®ï¼šå¦‚æœè¿™ä¸ªé˜¶æ®µå·²ç»è®¿é—®è¿‡ï¼Œä¸å†é‡å¤å›é€€
  if (visitedStages.value.has(currentStage)) {
    console.log(`é˜¶æ®µ${currentStage}å·²è®¿é—®è¿‡ï¼Œä¸å†é‡å¤å›é€€`)
    return false
  }

  // å…³é”®ä¼˜åŒ–ï¼šåªè¦èµ·å§‹é˜¶æ®µçš„ç¬¬2é¢˜ç­”é”™ï¼Œå°±ç«‹å³å¾€å›èµ°
  // è¿™æ ·å¯ä»¥å°½æ—©å‘ç°"å¤ªéš¾äº†"ï¼Œé¿å…è®©å®¶é•¿è¿ç»­å—æŒ«
  if (currentIndex.value === startIdx + 1) {
    const secondQuestionId = filteredQuestions.value[startIdx + 1]?.id
    if (secondQuestionId && answers.value.hasOwnProperty(secondQuestionId)) {
      // ç¬¬2é¢˜ç­”é”™äº†ï¼ˆscore = 0ï¼‰ï¼Œç«‹å³è§¦å‘å‘åå¯¼èˆª
      if (answers.value[secondQuestionId] === 0) {
        console.log('æ£€æµ‹åˆ°èµ·å§‹é˜¶æ®µç¬¬2é¢˜ç­”é”™ï¼Œè§¦å‘å‘åå¯¼èˆª')
        visitedStages.value.add(currentStage)  // æ ‡è®°å·²è®¿é—®
        return true
      }
    }
  }

  return false
}

// è®¡ç®—å‘åå¯¼èˆªçš„ç›®æ ‡ç´¢å¼•ï¼ˆè·³è½¬åˆ°å‰ä¸€é˜¶æ®µçš„ç¬¬ä¸€é¢˜ï¼‰
const calculateBackwardIndex = (): number => {
  const startIdx = ageStageStartIndex.value
  if (startIdx <= 0) return -1

  // æ‰¾åˆ°å‰ä¸€ä¸ªå¹´é¾„é˜¶æ®µçš„ç¬¬ä¸€é¢˜
  const currentStage = currentAgeStage.value?.stage
  if (!currentStage) return -1

  const previousStage = currentStage - 1
  const previousStageFirstQuestion = filteredQuestions.value.find(
    q => q.age_stage === previousStage
  )

  if (previousStageFirstQuestion) {
    const targetIndex = filteredQuestions.value.findIndex(
      q => q.id === previousStageFirstQuestion.id
    )
    console.log('å‘åå¯¼èˆªç›®æ ‡ï¼šé˜¶æ®µ', previousStage, 'çš„ç¬¬ä¸€é¢˜ï¼Œç´¢å¼•', targetIndex, 'ï¼Œé¢˜ç›®ID', previousStageFirstQuestion.id)
    return targetIndex
  }

  return -1
}

// ä¸‹ä¸€é¢˜
const nextQuestion = async () => {
  // ğŸ”‘ ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥å½“å‰é˜¶æ®µæ˜¯å¦å»ºç«‹åŸºçº¿
  if (!basalEstablished.value) {
    const currentStage = currentQuestion.value?.age_stage
    if (currentStage) {
      const stageQuestions = filteredQuestions.value.filter(q => q.age_stage === currentStage)
      const allAnswered = stageQuestions.every(q => answers.value.hasOwnProperty(q.id))

      // å¦‚æœå½“å‰é˜¶æ®µæ‰€æœ‰é¢˜ç›®éƒ½å·²å›ç­”ï¼Œæ£€æŸ¥æ˜¯å¦å»ºç«‹åŸºçº¿
      if (allAnswered) {
        checkBasalEstablished()
      }
    }
  }

  // ğŸ”‘ ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦å‘åå¯¼èˆªï¼ˆä»…åœ¨æœªå»ºç«‹åŸºçº¿æ—¶ï¼‰
  if (needsBackwardNavigation()) {
    const backwardIndex = calculateBackwardIndex()
    if (backwardIndex >= 0) {
      console.log('æ£€æµ‹åˆ°é¢˜ç›®è¾ƒéš¾ï¼Œè‡ªåŠ¨è°ƒæ•´åˆ°å‰ä¸€é˜¶æ®µ')
      ElMessage.info('ä¸ºäº†æ›´å‡†ç¡®è¯„ä¼°ï¼Œæˆ‘ä»¬ä»ç¨ç®€å•ä¸€ç‚¹çš„é¢˜ç›®å¼€å§‹')
      currentIndex.value = backwardIndex
      currentAnswer.value = null  // ğŸ”‘ ä¸é¢„å…ˆé€‰ä¸­ç­”æ¡ˆ
      justNavigated.value = true  // æ ‡è®°ä¸ºå¯¼èˆª
      return
    }
  }

  // ğŸ”‘ ç¬¬ä¸‰æ­¥ï¼šå¦‚æœåˆšå»ºç«‹åŸºçº¿ï¼Œè¿”å›åˆ°èµ·å§‹é˜¶æ®µç»§ç»­è¯„ä¼°
  if (basalEstablished.value && currentQuestion.value) {
    const currentStage = currentQuestion.value.age_stage
    const startStage = currentAgeStage.value?.stage

    // å¦‚æœå½“å‰åœ¨åŸºçº¿é˜¶æ®µä¸”åŸºçº¿é˜¶æ®µæ¯”èµ·å§‹é˜¶æ®µå°ï¼Œè¿”å›èµ·å§‹é˜¶æ®µ
    if (currentStage === basalStage.value && startStage && currentStage < startStage) {
      // æ‰¾åˆ°èµ·å§‹é˜¶æ®µç¬¬ä¸€ä¸ªæœªå›ç­”çš„é¢˜ç›®
      const startIdx = ageStageStartIndex.value
      let targetIndex = startIdx

      // ä»èµ·å§‹é˜¶æ®µå¼€å§‹ï¼Œæ‰¾ç¬¬ä¸€ä¸ªæœªå›ç­”çš„é¢˜ç›®
      for (let i = startIdx; i < filteredQuestions.value.length; i++) {
        const qid = filteredQuestions.value[i].id
        if (!answers.value.hasOwnProperty(qid)) {
          targetIndex = i
          break
        }
      }

      console.log(`åŸºçº¿å·²å»ºç«‹ï¼Œè¿”å›èµ·å§‹é˜¶æ®µï¼ˆç¬¬${startStage}é˜¶æ®µï¼‰ç¬¬ä¸€ä¸ªæœªå›ç­”é¢˜ç›®ï¼Œç´¢å¼•${targetIndex}`)
      ElMessage.info(`åŸºçº¿å·²ç¡®ç«‹ï¼Œè¿”å›ç¬¬${startStage}é˜¶æ®µç»§ç»­è¯„ä¼°`)
      currentIndex.value = targetIndex
      currentAnswer.value = null  // ğŸ”‘ ä¸é¢„å…ˆé€‰ä¸­ç­”æ¡ˆï¼Œè®©ç”¨æˆ·é‡æ–°é€‰æ‹©
      justNavigated.value = true  // æ ‡è®°ä¸ºå¯¼èˆª
      return
    }
  }

  // ğŸ”‘ ç¬¬å››æ­¥ï¼šåœ¨è¿›å…¥ä¸‹ä¸€é¢˜ä¹‹å‰ï¼Œæ£€æŸ¥æ˜¯å¦åº”è¯¥ç»“æŸè¯„ä¼°
  if (shouldEndAssessment(answers.value)) {
    console.log('æ ¹æ®S-Mè§„åˆ™ï¼Œè¯„ä¼°è‡ªåŠ¨ç»“æŸ')
    await completeAssessment()
    return
  }

  // ğŸ”‘ ç¬¬äº”æ­¥ï¼šæ­£å¸¸è¿›å…¥ä¸‹ä¸€é¢˜
  if (currentIndex.value < totalQuestions.value - 1) {
    currentIndex.value++
    currentAnswer.value = null  // ğŸ”‘ ä¸é¢„å…ˆé€‰ä¸­ç­”æ¡ˆï¼Œè®©ç”¨æˆ·é‡æ–°é€‰æ‹©
    justNavigated.value = true  // ğŸ”‘ æ ‡è®°ä¸ºå¯¼èˆªï¼Œå…è®¸é‡æ–°é€‰æ‹©ä¹‹å‰çš„ç­”æ¡ˆ
  } else {
    // å®Œæˆè¯„ä¼°
    await completeAssessment()
  }
}

// æ’­æ”¾è¯­éŸ³
const playAudio = () => {
  if (!currentQuestion.value || !('speechSynthesis' in window)) {
    ElMessage.warning('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æ’­æ”¾åŠŸèƒ½')
    return
  }

  // åœæ­¢å½“å‰æ’­æ”¾
  if (speechSynthesis && speechSynthesis.speaking) {
    speechSynthesis.cancel()
  }

  speechSynthesis = window.speechSynthesis
  currentUtterance = new SpeechSynthesisUtterance(currentQuestion.value.title)
  currentUtterance.lang = 'zh-CN'
  currentUtterance.rate = 0.9

  currentUtterance.onstart = () => {
    isPlaying.value = true
  }

  currentUtterance.onend = () => {
    isPlaying.value = false
  }

  speechSynthesis.speak(currentUtterance)
}

// è®¡ç®—S-Mé‡è¡¨ç²—åˆ†ï¼ˆæ ¹æ®é‡è¡¨å®˜æ–¹è§„åˆ™ï¼Œæ”¯æŒå‘åå¯¼èˆªï¼‰
const calculateSMRawScore = (answers: Record<number, number>, ageStage: number): number => {
  if (!smQuestions.value) return 0

  console.log('S-Mç²—åˆ†è®¡ç®—å¼€å§‹ - ageStage:', ageStage)
  console.log('ç­”æ¡ˆè¯¦æƒ…:', answers)

  // å„å¹´é¾„é˜¶æ®µçš„åŸºç¡€åˆ†ï¼ˆæ ¹æ®S-Mé‡è¡¨æ ‡å‡†ï¼‰
  const stageBaseScores: Record<number, number> = {
    1: 0,    // I.6ä¸ªæœˆ-1å²11ä¸ªæœˆ: åŸºç¡€åˆ†0
    2: 19,   // II.2å²-3å²5ä¸ªæœˆ: åŸºç¡€åˆ†19
    3: 41,   // III.3å²6ä¸ªæœˆ-4å²11ä¸ªæœˆ: åŸºç¡€åˆ†41
    4: 63,   // IV.5å²-6å²5ä¸ªæœˆ: åŸºç¡€åˆ†63
    5: 80,   // V.6å²6ä¸ªæœˆ-8å²5ä¸ªæœˆ: åŸºç¡€åˆ†80
    6: 96,   // VI.8å²6ä¸ªæœˆ-10å²5ä¸ªæœˆ: åŸºç¡€åˆ†96
    7: 113   // VII.10å²6ä¸ªæœˆä»¥ä¸Š: åŸºç¡€åˆ†113
  }

  // è·å–æ‰€æœ‰132é“é¢˜ç›®ï¼ŒæŒ‰IDæ’åº
  const allQuestions = smQuestions.value.sort((a, b) => a.id - b.id)

  // è·å–å¹´é¾„é˜¶æ®µçš„èµ·å§‹ç´¢å¼•
  const startIndex = ageStageStartIndex.value

  console.log('èµ·å§‹é˜¶æ®µ:', ageStage, ', èµ·å§‹ç´¢å¼•:', startIndex)

  // æŸ¥æ‰¾è¿ç»­10é¡¹é€šè¿‡çš„ä½ç½®ï¼ˆå¯èƒ½åœ¨å½“å‰é˜¶æ®µæˆ–æ›´æ—©é˜¶æ®µï¼‰
  let tenPassStartIndex = -1
  let tenPassEndIndex = -1

  // Phase 1: ä»èµ·å§‹é˜¶æ®µå‘å‰æœç´¢
  let consecutivePass = 0
  for (let i = startIndex; i < allQuestions.length; i++) {
    const qid = allQuestions[i].id
    if (!answers.hasOwnProperty(qid)) break

    if (answers[qid] === 1) {
      consecutivePass++
      if (consecutivePass === 10) {
        tenPassStartIndex = i - 9
        tenPassEndIndex = i
        console.log('å‘å‰æœç´¢ï¼šå‘ç°è¿ç»­10é¡¹é€šè¿‡ï¼Œä»é¢˜ç›®', allQuestions[tenPassStartIndex].id, 'åˆ°', allQuestions[i].id)
        break
      }
    } else {
      consecutivePass = 0
    }
  }

  // Phase 2: å¦‚æœå‘å‰æ²¡æ‰¾åˆ°ï¼Œå°è¯•å‘åæœç´¢
  if (tenPassStartIndex === -1 && startIndex > 0) {
    consecutivePass = 0
    for (let i = startIndex - 1; i >= 0; i--) {
      const qid = allQuestions[i].id
      if (!answers.hasOwnProperty(qid)) break

      if (answers[qid] === 1) {
        consecutivePass++
        if (consecutivePass === 10) {
          tenPassStartIndex = i
          tenPassEndIndex = i + 9
          console.log('å‘åæœç´¢ï¼šå‘ç°è¿ç»­10é¡¹é€šè¿‡ï¼Œä»é¢˜ç›®', allQuestions[i].id, 'åˆ°', allQuestions[tenPassEndIndex].id)
          break
        }
      } else {
        consecutivePass = 0
      }
    }
  }

  // ç¡®å®šæœ‰æ•ˆçš„åŸºç¡€åˆ†å’Œé€šè¿‡é¢˜ç›®æ•°
  let effectiveBaseScore = stageBaseScores[ageStage] || 0
  let finalPassedCount = 0

  if (tenPassStartIndex !== -1) {
    // æ‰¾åˆ°äº†è¿ç»­10é¡¹é€šè¿‡ï¼Œç¡®å®šæœ‰æ•ˆçš„å¹´é¾„é˜¶æ®µå’ŒåŸºç¡€åˆ†
    const tenPassQuestion = allQuestions[tenPassStartIndex]
    const effectiveAgeStage = tenPassQuestion.age_stage
    effectiveBaseScore = stageBaseScores[effectiveAgeStage] || 0

    console.log('è¿ç»­10é¡¹é€šè¿‡èµ·å§‹é¢˜ç›®æ‰€åœ¨é˜¶æ®µ:', effectiveAgeStage, ', ä½¿ç”¨åŸºç¡€åˆ†:', effectiveBaseScore)

    // S-Mè§„åˆ™ï¼šè¿ç»­10é¡¹é€šè¿‡ï¼Œå‰é¢æ‰€æœ‰é¡¹ç›®è§†ä¸ºé€šè¿‡
    // ä»è¿ç»­10é¡¹é€šè¿‡çš„ä½ç½®å¼€å§‹ï¼Œè®¡ç®—é€šè¿‡çš„é¢˜ç›®æ•°

    // 1. è¿ç»­10é¡¹é€šè¿‡æœ¬èº«
    finalPassedCount = 10

    // 2. è¿ç»­10é¡¹é€šè¿‡ä¹‹åçš„é€šè¿‡é¢˜ç›®
    for (let i = tenPassEndIndex + 1; i < allQuestions.length; i++) {
      const qid = allQuestions[i].id
      if (answers.hasOwnProperty(qid)) {
        if (answers[qid] === 1) {
          finalPassedCount++
        }
      } else {
        break
      }
    }

    console.log('S-Mè§„åˆ™è®¡ç®—ç»“æœï¼š')
    console.log('- è¿ç»­10é¡¹é€šè¿‡:', 10, 'é¢˜')
    console.log('- è¿ç»­10é¡¹åçš„é€šè¿‡é¢˜ç›®:', finalPassedCount - 10, 'é¢˜')
    console.log('- æ€»é€šè¿‡é¢˜ç›®æ•°:', finalPassedCount)

  } else {
    // æ²¡æœ‰æ‰¾åˆ°è¿ç»­10é¡¹é€šè¿‡ï¼Œåªè®¡ç®—å®é™…é€šè¿‡çš„é¢˜ç›®
    console.log('æ²¡æœ‰è¿ç»­10é¡¹é€šè¿‡ï¼Œåªè®¡ç®—å®é™…é€šè¿‡é¢˜ç›®')

    for (const qid in answers) {
      if (answers[qid] === 1) {
        finalPassedCount++
      }
    }
  }

  const finalRawScore = effectiveBaseScore + finalPassedCount
  console.log('æœ€ç»ˆé€šè¿‡é¢˜ç›®æ•°:', finalPassedCount)
  console.log('æœ€ç»ˆS-Mç²—åˆ†:', finalRawScore, '(åŸºç¡€åˆ†:', effectiveBaseScore, '+ é€šè¿‡æ•°:', finalPassedCount, ')')

  return finalRawScore
}

// å®Œæˆè¯„ä¼°
const completeAssessment = async () => {
  let savedAssessId: number | null = null  // æå‰å£°æ˜å˜é‡

  try {
    // æ ¹æ®S-Mé‡è¡¨è§„åˆ™è®¡ç®—ç²—åˆ†
    console.log('å¼€å§‹è®¡ç®—S-Mç²—åˆ†...')
    console.log('answers.value:', answers.value)
    console.log('currentAgeStage.value?.stage:', currentAgeStage.value?.stage)

    const rawScore = calculateSMRawScore(answers.value, currentAgeStage.value?.stage)

    console.log('è®¡ç®—å¾—åˆ°çš„ç²—åˆ†:', rawScore)
    console.log('å­¦ç”Ÿæœˆé¾„:', studentAgeInMonths.value, 'ä¸ªæœˆ')

    // è®¡ç®—æ ‡å‡†åˆ†
    const sqScore = calculateSQScore.value(rawScore, studentAgeInMonths.value)
    console.log('è®¡ç®—å¾—åˆ°çš„æ ‡å‡†åˆ†:', sqScore)

    // è·å–è¯„å®šç­‰çº§
    const level = getEvaluationLevel.value(sqScore)
    console.log('è¯„å®šç­‰çº§:', level)

    // ä¿å­˜è¯„ä¼°ç»“æœ
    const assessData = {
      student_id: parseInt(studentId.value),
      age_stage: currentAgeStage.value?.stage,
      raw_score: rawScore, // å·²ç»æ˜¯æŒ‰è§„åˆ™è®¡ç®—çš„ç²—åˆ†
      actual_pass_count: Object.values(answers.value).reduce((sum, score) => sum + score, 0), // å®é™…é€šè¿‡çš„é¡¹ç›®æ•°
      sq_score: sqScore,
      level: level,
      start_time: new Date().toISOString(),
      end_time: new Date().toISOString(),
      answers: answers.value
    }

    // ä¿å­˜åˆ°æ•°æ®åº“
    try {
      const api = new SMAssessmentAPI()

      console.log('ğŸš€ å¼€å§‹ä¿å­˜S-Mè¯„ä¼°è®°å½•...')

      // å°è¯•æ–¹æ³•1: ä½¿ç”¨APIçš„createAssessment
      savedAssessId = await api.createAssessment(assessData)
      console.log('ğŸš€ APIè¿”å›çš„ID:', savedAssessId)

      // å¦‚æœè¿”å›0ï¼Œå°è¯•ç›´æ¥æŸ¥è¯¢æœ€æ–°è®°å½•
      if (savedAssessId === 0) {
        console.log('âš ï¸ APIè¿”å›IDä¸º0ï¼Œå°è¯•ç›´æ¥æŸ¥è¯¢æœ€æ–°è®°å½•...')

        // ç›´æ¥ä»æ•°æ®åº“æŸ¥è¯¢æœ€æ–°çš„è¯„ä¼°è®°å½•
        const allAssessments = api.getStudentAssessments(parseInt(studentId.value))
        console.log('ğŸ” æŸ¥è¯¢åˆ°çš„æ‰€æœ‰è¯„ä¼°è®°å½•:', allAssessments)

        if (allAssessments && allAssessments.length > 0) {
          // è·å–æœ€æ–°çš„ä¸€æ¡ï¼ˆæŒ‰IDé™åºæ’åºåçš„ç¬¬ä¸€æ¡ï¼‰
          const latest = allAssessments.sort((a: any, b: any) => b.id - a.id)[0]
          savedAssessId = latest.id
          console.log('âœ… ä»æŸ¥è¯¢ç»“æœä¸­è·å–åˆ°ID:', savedAssessId)
        }
      }

      if (savedAssessId === 0) {
        throw new Error('æ— æ³•è·å–è¯„ä¼°è®°å½•ID')
      }

      // ä¿å­˜è¯„ä¼°è¯¦æƒ…
      const details = Object.entries(answers.value).map(([questionId, score]) => ({
        assess_id: savedAssessId,
        question_id: parseInt(questionId),
        score: score,
        answer_time: 0
      }))

      console.log('å‡†å¤‡ä¿å­˜çš„è¯„ä¼°è¯¦æƒ…:', details)
      console.log('details.length:', details.length)

      for (const detail of details) {
        await api.saveAssessmentDetail(detail)
        console.log('å·²ä¿å­˜è¯¦æƒ…:', detail)
      }

      assessId.value = savedAssessId.toString()
      console.log('âœ… S-Mè¯„ä¼°æ•°æ®å·²ä¿å­˜åˆ°æ•°æ®åº“ï¼ŒID:', savedAssessId)
    } catch (error) {
      console.error('ä¿å­˜S-Mè¯„ä¼°æ•°æ®å¤±è´¥:', error)
      // å¦‚æœæ•°æ®åº“ä¿å­˜å¤±è´¥ï¼Œæš‚æ—¶ä¿å­˜åˆ°localStorage
      const assessResultKey = `sm_assess_result_${studentId.value}_${Date.now()}`
      localStorage.setItem(assessResultKey, JSON.stringify(assessData))
      localStorage.setItem(`latest_sm_assess_${studentId.value}`, assessResultKey)
    }

    console.log('è¯„ä¼°ç»“æœå·²ä¿å­˜:', assessData)

    // ä¿å­˜æŠ¥å‘Šè®°å½•
    if (savedAssessId) {
      try {
        const reportAPI = new ReportAPI()
        const reportTitle = `S-Mé‡è¡¨è¯„ä¼°æŠ¥å‘Š_${student.value?.name}_${new Date().toLocaleDateString()}`
        reportAPI.saveReportRecord({
          student_id: parseInt(studentId.value),
          report_type: 'sm',
          assess_id: savedAssessId,
          title: reportTitle
        })
        console.log('âœ… æŠ¥å‘Šè®°å½•å·²ä¿å­˜')
      } catch (error) {
        console.error('ä¿å­˜æŠ¥å‘Šè®°å½•å¤±è´¥:', error)
        // æŠ¥å‘Šè®°å½•ä¿å­˜å¤±è´¥ä¸å½±å“è¯„ä¼°æµç¨‹
      }
    } else {
      console.warn('âš ï¸ savedAssessId ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜æŠ¥å‘Šè®°å½•')
    }

    // ğŸ”‘ é‡è¦ï¼šè¯„ä¼°å®Œæˆåæ¸…é™¤è¿›åº¦æ•°æ®ï¼Œç¡®ä¿ä¸‹æ¬¡é‡æ–°è¯„ä¼°æ—¶ä»å¤´å¼€å§‹
    clearProgress()
    console.log('âœ… å·²æ¸…é™¤è¯„ä¼°è¿›åº¦æ•°æ®')

    showCompleteDialog.value = true
  } catch (error) {
    console.error('å®Œæˆè¯„ä¼°å¤±è´¥:', error)
    ElMessage.error('å®Œæˆè¯„ä¼°å¤±è´¥ï¼Œè¯·é‡è¯•')
  }
}

// ä¿å­˜è¿›åº¦
const saveProgress = () => {
  const progress = {
    studentId: studentId.value,
    currentIndex: currentIndex.value,
    answers: answers.value,
    basalEstablished: basalEstablished.value,
    visitedStages: Array.from(visitedStages.value),
    basalStage: basalStage.value,
    timestamp: new Date().toISOString()
  }
  localStorage.setItem(`sm_progress_${studentId.value}`, JSON.stringify(progress))
}

// åŠ è½½è¿›åº¦
const loadProgress = () => {
  const saved = localStorage.getItem(`sm_progress_${studentId.value}`)
  if (saved) {
    const progress = JSON.parse(saved)
    // æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€å¤©çš„è¿›åº¦
    const savedDate = new Date(progress.timestamp)
    const today = new Date()
    if (savedDate.toDateString() === today.toDateString()) {
      currentIndex.value = progress.currentIndex || 0
      answers.value = progress.answers || {}
      basalEstablished.value = progress.basalEstablished || false
      visitedStages.value = new Set(progress.visitedStages || [])
      basalStage.value = progress.basalStage || null

      // ğŸ”‘ å…³é”®ä¿®å¤ï¼šä¸è¦é¢„å…ˆé€‰ä¸­ç­”æ¡ˆï¼Œè®©ç”¨æˆ·é‡æ–°é€‰æ‹©
      currentAnswer.value = null  // æ¸…ç©ºå½“å‰ç­”æ¡ˆæ˜¾ç¤º

      // ğŸ”‘ å…³é”®ä¿®å¤ï¼šåŠ è½½è¿›åº¦åæ ‡è®°ä¸ºå¯¼èˆªçŠ¶æ€ï¼Œå…è®¸é‡æ–°ç¡®è®¤ç­”æ¡ˆ
      justNavigated.value = true

      console.log('âœ… å·²åŠ è½½è¿›åº¦ï¼š', {
        currentIndex: currentIndex.value,
        basalEstablished: basalEstablished.value,
        visitedStages: Array.from(visitedStages.value),
        basalStage: basalStage.value,
        justNavigated: justNavigated.value,
        currentQuestionHasAnswer: answers.value[filteredQuestions.value[currentIndex.value]?.id] !== undefined
      })

      // åŠ è½½è¿›åº¦åï¼Œæ£€æŸ¥æ˜¯å¦åº”è¯¥ç»“æŸè¯„ä¼°
      setTimeout(() => {
        if (shouldEndAssessment(answers.value)) {
          console.log('æ¢å¤è¿›åº¦æ—¶æ£€æµ‹åˆ°è¯„ä¼°åº”è¯¥ç»“æŸ')
          completeAssessment()
        }
      }, 100)
    }
  }
}

// æ¸…é™¤è¿›åº¦
const clearProgress = () => {
  localStorage.removeItem(`sm_progress_${studentId.value}`)
}

// ä¿å­˜å¹¶é€€å‡º
const saveAndExit = () => {
  clearProgress()
  router.push('/assessment')
}

// æŸ¥çœ‹æŠ¥å‘Š
const viewReport = () => {
  clearProgress()
  router.push({
    path: '/assessment/sm/report',
    query: {
      assessId: assessId.value,
      studentId: studentId.value
    }
  })
}

// é¡µé¢ç¦»å¼€å‰ç¡®è®¤
onBeforeUnmount(() => {
  if (speechSynthesis && speechSynthesis.speaking) {
    speechSynthesis.cancel()
  }
})

// å¼€å§‹è¯„ä¼°ï¼ˆå…³é—­æ¸©é¦¨æç¤ºå¯¹è¯æ¡†ï¼‰
const startAssessment = () => {
  showWelcomeDialog.value = false
}

// åˆå§‹åŒ–
onMounted(async () => {
  // åŠ¨æ€å¯¼å…¥é‡è¡¨æ•°æ®
  try {
    const [smQuestionsModule, smNormsModule] = await Promise.all([
      import('@/database/sm-questions'),
      import('@/database/sm-norms')
    ])
    smQuestions.value = smQuestionsModule.smQuestions
    smAgeRanges.value = smNormsModule.smAgeRanges
    calculateSQScore.value = smNormsModule.calculateSQScore
    getEvaluationLevel.value = smNormsModule.getEvaluationLevel
  } catch (error) {
    console.error('åŠ è½½é‡è¡¨æ•°æ®å¤±è´¥:', error)
    ElMessage.error('åŠ è½½é‡è¡¨æ•°æ®å¤±è´¥')
    router.push('/assessment')
    return
  }

  // è·å–å­¦ç”Ÿä¿¡æ¯
  await studentStore.loadStudents()

  if (!student.value) {
    ElMessage.error('å­¦ç”Ÿä¿¡æ¯ä¸å­˜åœ¨')
    router.push('/assessment')
    return
  }

  // åŠ è½½è¿›åº¦
  loadProgress()

  // å¦‚æœæ²¡æœ‰åŠ è½½åˆ°è¿›åº¦ï¼Œè®¾ç½®åˆå§‹ç´¢å¼•ä¸ºå¹´é¾„é˜¶æ®µçš„èµ·å§‹ä½ç½®
  if (currentIndex.value === 0 && Object.keys(answers.value).length === 0) {
    currentIndex.value = ageStageStartIndex.value
  }

  // æ£€æŸ¥æ˜¯å¦æœ‰é¢˜ç›®
  if (filteredQuestions.value.length === 0) {
    ElMessage.error('è¯¥å¹´é¾„æ®µæš‚æ— è¯„ä¼°é¢˜ç›®')
    router.push('/assessment')
    return
  }
})
</script>

<style scoped>
.sm-assessment {
  padding: 20px;
  max-width: 800px;
  margin: 0 auto;
}

/* æ¸©é¦¨æç¤ºå¯¹è¯æ¡†æ ·å¼ */
:deep(.welcome-dialog) {
  border-radius: 8px;
}

:deep(.welcome-dialog .el-dialog__header) {
  display: none;
}

:deep(.welcome-dialog .el-dialog__body) {
  padding: 20px 20px 10px;
  max-height: 400px;
  overflow-y: auto;
}

.welcome-content {
  padding: 0;
}

.welcome-intro {
  font-size: 14px;
  color: #606266;
  line-height: 1.6;
  text-align: center;
  margin-bottom: 15px;
  font-weight: 500;
}

.welcome-sections {
  margin-bottom: 15px;
}

.welcome-section {
  margin-bottom: 12px;
  padding: 12px;
  background: #f5f7fa;
  border-radius: 6px;
  border-left: 3px solid #409eff;
}

.welcome-section h4 {
  margin: 0 0 6px 0;
  font-size: 14px;
  color: #303133;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-icon {
  font-size: 16px;
}

.welcome-section p {
  margin: 0;
  font-size: 13px;
  color: #606266;
  line-height: 1.5;
  padding-left: 24px;
}

.welcome-footer {
  text-align: center;
  font-size: 13px;
  color: #409eff;
  font-weight: 500;
  margin: 12px 0 0 0;
}

.dialog-footer {
  text-align: center;
  padding: 5px 20px 15px;
}

:deep(.dialog-footer .el-button) {
  min-width: 140px;
  font-size: 14px;
  padding: 10px 24px;
}

.assessment-header {
  margin-bottom: 20px;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 30px;
}

.student-info h3 {
  margin: 0 0 10px 0;
  color: #303133;
}

.info-row {
  display: flex;
  gap: 20px;
  color: #606266;
}

.progress-info {
  flex: 1;
  max-width: 300px;
}

.progress-text {
  text-align: center;
  margin-top: 10px;
  color: #606266;
}

.question-card {
  min-height: 400px;
}

.question-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.question-number {
  font-weight: bold;
  color: #303133;
}

.question-stage {
  background: #f4f4f5;
  color: #909399;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 14px;
  margin: 0 8px;
}

.question-dimension {
  background: #e1f3d8;
  color: #67c23a;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 14px;
}

.question-content {
  padding: 20px 0;
}

.question-title {
  font-size: 18px;
  color: #303133;
  line-height: 1.6;
  margin-bottom: 20px;
}

.question-actions {
  margin-bottom: 30px;
}

.answer-options {
  margin-top: 30px;
}

.answer-options :deep(.el-radio) {
  display: block;
  margin-bottom: 20px;
  padding: 15px;
  border: 1px solid #dcdfe6;
  border-radius: 4px;
  transition: all 0.3s;
}

.answer-options :deep(.el-radio:hover) {
  border-color: #409eff;
  background-color: #f5f7fa;
}

.answer-options :deep(.el-radio.is-checked) {
  border-color: #409eff;
  background-color: #ecf5ff;
}

.option-label {
  font-weight: bold;
  margin-right: 10px;
  color: #409eff;
}

.option-desc {
  color: #606266;
}

.question-footer {
  display: flex;
  justify-content: space-between;
  margin-top: 40px;
  padding-top: 20px;
  border-top: 1px solid #dcdfe6;
}

.complete-content {
  text-align: center;
  padding: 20px 0;
}

.success-icon {
  margin-bottom: 20px;
}

.complete-content h3 {
  margin: 0 0 10px 0;
  color: #303133;
}

.complete-content p {
  margin: 0;
  color: #606266;
}
</style>

<!--
  @deprecated
  æ­¤æ–‡ä»¶å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ç»Ÿä¸€çš„è¯„ä¼°å®¹å™¨ AssessmentContainer.vue

  æ–°è·¯ç”±: /assessment/unified/conners-psq/:studentId
  é©±åŠ¨å™¨: src/strategies/assessment/ConnersPSQDriver.ts

  Phase 4 é‡æ„ï¼šè¯„ä¼°æ¨¡å—å·²è¿ç§»åˆ°"UI å®¹å™¨å¤ç”¨ + ç­–ç•¥é©±åŠ¨å™¨"æ¶æ„ã€‚
  æ­¤æ–‡ä»¶ä»…ä½œä¸ºå†å²å‚è€ƒä¿ç•™ï¼Œä¸åº”å†è¢«è·¯ç”±å¼•ç”¨ã€‚

  è¿ç§»æ—¥æœŸ: 2026-02-24
-->
<!-- src/views/assessment/conners-psq/Assessment.vue -->
<template>
  <div class="conners-psq-assessment">
    <!-- æ¬¢è¿å¯¹è¯æ¡† -->
    <el-dialog
      v-model="showWelcomeDialog"
      title=""
      width="580px"
      append-to-body
      :close-on-click-modal="false"
      :close-on-press-escape="false"
      :show-close="false"
      class="welcome-dialog"
      draggable
    >
      <div class="welcome-content">
        <h2>Conners çˆ¶æ¯ç”¨é—®å· (PSQ)</h2>
        <p class="welcome-intro">æœ¬é—®å·ç”¨äºè¯„ä¼°3-17å²å„¿ç«¥çš„è¡Œä¸ºè¡¨ç°ï¼Œç”±çˆ¶æ¯æ ¹æ®å­©å­æœ€è¿‘6ä¸ªæœˆåœ¨å®¶ä¸­çš„æƒ…å†µå¡«å†™ã€‚å…±48é¢˜ï¼ŒåŒ…å«å“è¡Œé—®é¢˜ã€å­¦ä¹ é—®é¢˜ã€å†²åŠ¨æ€§ã€ç„¦è™‘å’Œå¤šåŠ¨æŒ‡æ•°äº”ä¸ªç»´åº¦ã€‚</p>

        <div class="welcome-sections">
          <div class="welcome-section">
            <h4><span class="section-icon">ğŸ“‹</span> è¯„åˆ†è¯´æ˜</h4>
            <p>è¯·æ ¹æ®å­©å­<strong>æœ€è¿‘6ä¸ªæœˆ</strong>åœ¨å®¶ä¸­çš„å®é™…è¡¨ç°è¿›è¡Œè¯„åˆ†ï¼š</p>
            <ul>
              <li><strong>A (0åˆ†)</strong> - æ— ï¼šå®Œå…¨æ²¡æœ‰è¿™ç§æƒ…å†µ</li>
              <li><strong>B (1åˆ†)</strong> - ç¨æœ‰ï¼šå¶å°”å‡ºç°ï¼Œç¨‹åº¦è½»å¾®</li>
              <li><strong>C (2åˆ†)</strong> - ç›¸å½“å¤šï¼šç»å¸¸å‡ºç°ï¼Œç¨‹åº¦ä¸­ç­‰</li>
              <li><strong>D (3åˆ†)</strong> - å¾ˆå¤šï¼šé¢‘ç¹å‡ºç°ï¼Œç¨‹åº¦ä¸¥é‡</li>
            </ul>
          </div>

          <div class="welcome-section">
            <h4><span class="section-icon">â±ï¸</span> è¯„ä¼°æ—¶é—´</h4>
            <p>çº¦10-15åˆ†é’Ÿï¼Œè¯·ç¡®ä¿åœ¨å®‰é™ã€æ— å¹²æ‰°çš„ç¯å¢ƒä¸‹è¿›è¡Œè¯„ä¼°ã€‚</p>
          </div>

          <div class="welcome-section">
            <h4><span class="section-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span> è¯„ä¼°äºº</h4>
            <p>å»ºè®®ç”±æœ€äº†è§£å­©å­çš„çˆ¶æ¯æˆ–ä¸»è¦ç…§é¡¾è€…å¡«å†™ã€‚</p>
          </div>

          <div class="welcome-section">
            <h4><span class="section-icon">ğŸ’¡</span> æ¸©é¦¨æç¤º</h4>
            <p>è¯·æ ¹æ®å­©å­çš„å®é™…æƒ…å†µçœŸå®å¡«å†™ï¼Œä¸è¦è¿‡åˆ†æ‹…å¿§æˆ–åˆ»æ„ç¾åŒ–ã€‚å¦‚æœé‡åˆ°ä¸ç¡®å®šçš„é¢˜ç›®ï¼Œå¯ä»¥æ ¹æ®æ‚¨çš„æ•´ä½“å°è±¡ä½œç­”ã€‚</p>
          </div>
        </div>

        <p class="welcome-footer">æ„Ÿè°¢æ‚¨çš„é…åˆï¼Œè¿™å°†å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°äº†è§£å’Œå¸®åŠ©å­©å­ï¼</p>
      </div>
      <template #footer>
        <el-button type="primary" size="large" @click="startAssessment">
          æˆ‘å·²äº†è§£ï¼Œå¼€å§‹è¯„ä¼°
        </el-button>
      </template>
    </el-dialog>

    <!-- è¯„ä¼°å¤´éƒ¨ -->
    <el-card class="assessment-header">
      <div class="header-content">
        <div class="student-info">
          <h3>Conners çˆ¶æ¯é—®å·è¯„ä¼° (PSQ)</h3>
          <div class="info-row">
            <span>å­¦ç”Ÿï¼š{{ student?.name }}</span>
            <span>æ€§åˆ«ï¼š{{ student?.gender }}</span>
            <span>å¹´é¾„ï¼š{{ studentAge }}å²</span>
            <span>é¢˜ç›®ï¼š48é¢˜</span>
            <span v-if="currentDimension">å½“å‰ç»´åº¦ï¼š{{ getDimensionName(currentDimension) }}</span>
          </div>
        </div>
        <div class="progress-info">
          <el-progress
            :percentage="progressPercentage"
            :format="progressFormat"
            :stroke-width="20"
          />
          <div class="progress-text">
            å·²å®Œæˆï¼š{{ currentIndex + 1 }} / 48
          </div>
        </div>
      </div>
    </el-card>

    <!-- é¢˜ç›®å¡ç‰‡ -->
    <el-card class="question-card" v-if="currentQuestion">
      <div class="question-header">
        <span class="question-number">ç¬¬ {{ currentIndex + 1 }} é¢˜</span>
        <span class="question-dimension">{{ getDimensionName(currentQuestion.dimension) }}</span>
      </div>

      <div class="question-content">
        <div class="question-title">
          {{ currentQuestion.content }}
        </div>

        <!-- è¯­éŸ³æ’­æ”¾æŒ‰é’® -->
        <div class="question-actions">
          <el-button
            type="info"
            :icon="Microphone"
            @click="playAudio"
            :loading="isPlaying"
          >
            {{ isPlaying ? 'æ’­æ”¾ä¸­...' : 'æœ—è¯»é¢˜ç›®' }}
          </el-button>
        </div>

        <!-- ç­”æ¡ˆé€‰é¡¹ -->
        <div class="answer-options">
          <el-radio-group v-model="currentAnswer" @change="handleAnswer">
            <el-radio-button
              v-for="option in answerOptions"
              :key="option.value"
              :label="option.value"
              class="answer-option"
            >
              <span class="option-label">{{ option.label }}</span>
              <span class="option-desc">{{ option.desc }}</span>
            </el-radio-button>
          </el-radio-group>
        </div>
      </div>

      <!-- å¯¼èˆªæŒ‰é’® -->
      <div class="question-nav">
        <el-button
          :disabled="currentIndex === 0"
          @click="previousQuestion"
          size="large"
        >
          ä¸Šä¸€é¢˜
        </el-button>
        <el-button
          type="primary"
          :disabled="!currentAnswer && currentAnswer !== 0"
          @click="nextQuestion"
          size="large"
        >
          {{ isLastQuestion ? 'å®Œæˆè¯„ä¼°' : 'ä¸‹ä¸€é¢˜' }}
        </el-button>
      </div>
    </el-card>

    <!-- å®Œæˆç¡®è®¤å¯¹è¯æ¡† -->
    <el-dialog
      v-model="showConfirmDialog"
      title="ç¡®è®¤å®Œæˆ"
      width="400px"
    >
      <p>æ‚¨å·²å®Œæˆæ‰€æœ‰é¢˜ç›®ï¼Œæ˜¯å¦æäº¤è¯„ä¼°ç»“æœï¼Ÿ</p>
      <template #footer>
        <el-button @click="showConfirmDialog = false">è¿”å›æ£€æŸ¥</el-button>
        <el-button type="primary" @click="submitAssessment">æäº¤è¯„ä¼°</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { ElMessage } from 'element-plus'
import { Microphone } from '@element-plus/icons-vue'
import { connorsPSQQuestions, type ConnersPSQQuestion } from '@/database/conners-psq-questions'
import { calculateConnersScores } from '@/database/conners-scoring'
import { ConnersPSQAPI, ReportAPI } from '@/database/api'
import { getDatabase } from '@/database/init'
import type { ConnersAnswer } from '@/types/conners'

const router = useRouter()
const route = useRoute()
const db = getDatabase()
const psqAPI = new ConnersPSQAPI(db)

// çŠ¶æ€
const showWelcomeDialog = ref(true)
const showConfirmDialog = ref(false)
const student = ref<any>(null)
const currentIndex = ref(0)
const answers = ref<ConnersAnswer[]>([])
const currentAnswer = ref<number | null>(null)
const isPlaying = ref(false)
const startTime = ref(Date.now())
const assessId = ref<number | null>(null)

// ç»´åº¦åç§°æ˜ å°„
const dimensionNames: Record<string, string> = {
  conduct: 'å“è¡Œé—®é¢˜',
  learning: 'å­¦ä¹ é—®é¢˜',
  psychosomatic: 'å¿ƒèº«éšœç¢',
  impulsivity_hyperactivity: 'å†²åŠ¨æ€§',
  anxiety: 'ç„¦è™‘',
  hyperactivity_index: 'å¤šåŠ¨æŒ‡æ•°'
}

// ç­”æ¡ˆé€‰é¡¹ (0-3åˆ†: A.æ— , B.ç¨æœ‰, C.ç›¸å½“å¤š, D.å¾ˆå¤š)
const answerOptions = [
  { value: 0, label: 'A', desc: 'æ— ' },
  { value: 1, label: 'B', desc: 'ç¨æœ‰' },
  { value: 2, label: 'C', desc: 'ç›¸å½“å¤š' },
  { value: 3, label: 'D', desc: 'å¾ˆå¤š' }
]

// é¢˜ç›®åˆ—è¡¨
const questions = connorsPSQQuestions

// å½“å‰é¢˜ç›®
const currentQuestion = computed(() => {
  return questions[currentIndex.value]
})

// å½“å‰ç»´åº¦
const currentDimension = computed(() => {
  return currentQuestion.value?.dimension
})

// è¿›åº¦
const progressPercentage = computed(() => {
  return ((currentIndex.value + 1) / questions.length) * 100
})

// å­¦ç”Ÿæœˆé¾„ï¼ˆä»ç”Ÿæ—¥è®¡ç®—ï¼‰
const studentAgeMonths = computed(() => {
  if (!student.value?.birthday) return 0
  const birth = new Date(student.value.birthday)
  const today = new Date()
  const months = (today.getFullYear() - birth.getFullYear()) * 12 +
    (today.getMonth() - birth.getMonth())
  // å¦‚æœå½“æœˆæ—¥æœŸè¿˜æ²¡åˆ°ï¼Œå‡1ä¸ªæœˆ
  if (today.getDate() < birth.getDate()) {
    return Math.max(0, months - 1)
  }
  return Math.max(0, months)
})

// å­¦ç”Ÿå¹´é¾„ï¼ˆå²ï¼‰
const studentAge = computed(() => {
  return Math.floor(studentAgeMonths.value / 12)
})

// æ˜¯å¦æœ€åä¸€é¢˜
const isLastQuestion = computed(() => {
  return currentIndex.value === questions.length - 1
})

// è¿›åº¦æ ¼å¼
const progressFormat = (percentage: number) => {
  return `${Math.round(percentage)}%`
}

// è·å–ç»´åº¦åç§°
const getDimensionName = (dimension: string) => {
  return dimensionNames[dimension] || dimension
}

// å¼€å§‹è¯„ä¼°
const startAssessment = () => {
  showWelcomeDialog.value = false
  startTime.value = Date.now()
}

// æ’­æ”¾è¯­éŸ³
const playAudio = () => {
  if (!currentQuestion.value) return

  // Cancel any ongoing speech
  speechSynthesis.cancel()

  isPlaying.value = true
  const utterance = new SpeechSynthesisUtterance(currentQuestion.value.content)
  utterance.lang = 'zh-CN'
  utterance.onend = () => {
    if (isPlaying.value) {
      isPlaying.value = false
    }
  }
  speechSynthesis.speak(utterance)
}

// å¤„ç†ç­”æ¡ˆ
const handleAnswer = () => {
  if (!currentQuestion.value) {
    console.error('No current question')
    return
  }
  const answerTime = Date.now() - startTime.value
  answers.value.push({
    question_id: currentQuestion.value.id,
    score: currentAnswer.value!,
    answer_time: answerTime
  })
  // è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜
  setTimeout(() => {
    nextQuestion()
  }, 300)
}

// ä¸‹ä¸€é¢˜
const nextQuestion = () => {
  if (isLastQuestion.value) {
    showConfirmDialog.value = true
  } else {
    currentIndex.value++
    currentAnswer.value = null
    startTime.value = Date.now()
  }
}

// ä¸Šä¸€é¢˜
const previousQuestion = () => {
  if (currentIndex.value > 0) {
    // ç§»é™¤æœ€åä¸€é¢˜çš„ç­”æ¡ˆ
    answers.value.pop()
    currentIndex.value--
    // æ¢å¤ä¸Šä¸€é¢˜çš„ç­”æ¡ˆ
    const lastAnswer = answers.value.find(a => a.question_id === questions[currentIndex.value].id)
    currentAnswer.value = lastAnswer?.score ?? null
  }
}

// æäº¤è¯„ä¼°
const submitAssessment = async () => {
  try {
    const ageMonths = studentAgeMonths.value

    // æ„å»ºç­”æ¡ˆå¯¹è±¡ç”¨äºè¯„åˆ†
    const answersMap: Record<number, number | null> = {}
    for (const answer of answers.value) {
      answersMap[answer.question_id] = answer.score
    }

    // è®¡ç®—åˆ†æ•°
    const scoreResult = await calculateConnersScores(
      answersMap,
      {
        gender: student.value.gender,
        birthday: student.value.birthday
      },
      'psq'
    )

    // æå–åŸå§‹åˆ†å’Œç»´åº¦åˆ†æ•°
    const rawScores: Record<string, number> = {}
    const dimensionScores: Record<string, any> = {}

    for (const [dim, result] of Object.entries(scoreResult.dimensionScores)) {
      rawScores[dim] = result.rawScore
      dimensionScores[dim] = result
    }

    // åˆ›å»ºè¯„ä¼°è®°å½•
    // ç¡®ä¿ hyperactivity_index ä» tScores ä¸­è·å–
    const hyperIndexT = scoreResult.tScores.hyperactivity_index ?? 0

    const resultId = psqAPI.createAssessment({
      student_id: student.value.id,
      gender: student.value.gender,
      age_months: ageMonths,
      raw_scores: JSON.stringify(rawScores),
      dimension_scores: JSON.stringify(dimensionScores),
      t_scores: JSON.stringify(scoreResult.tScores),
      pi_score: 0,  // 1978å¹´ä¿®è®¢ç‰ˆæ— PIæ•ˆåº¦é¢˜
      ni_score: 0,  // 1978å¹´ä¿®è®¢ç‰ˆæ— NIæ•ˆåº¦é¢˜
      is_valid: 1,
      invalid_reason: null,
      hyperactivity_index: hyperIndexT,
      level: scoreResult.level,
      start_time: new Date(startTime.value).toISOString(),
      end_time: new Date().toISOString()
    })

    assessId.value = resultId

    // åˆ›å»ºæŠ¥å‘Šè®°å½•
    try {
      const reportAPI = new ReportAPI()
      const title = `Connersçˆ¶æ¯é—®å·æŠ¥å‘Š(PSQ)_${student.value.name}_${new Date().toLocaleDateString()}`
      reportAPI.saveReportRecord({
        student_id: student.value.id,
        report_type: 'conners-psq',
        assess_id: resultId,
        title
      })
    } catch (error) {
      console.error('åˆ›å»ºæŠ¥å‘Šè®°å½•å¤±è´¥:', error)
      // ä¸å½±å“è¯„ä¼°æäº¤æµç¨‹ï¼Œä»…è®°å½•é”™è¯¯
    }

    ElMessage.success('è¯„ä¼°å®Œæˆï¼')

    // è·³è½¬åˆ°æŠ¥å‘Šé¡µé¢
    router.push(`/assessment/conners-psq/report/${assessId.value}`)
  } catch (error) {
    console.error('æäº¤è¯„ä¼°å¤±è´¥:', error)
    ElMessage.error('æäº¤è¯„ä¼°å¤±è´¥ï¼Œè¯·é‡è¯•')
  }
}

// è·å–å­¦ç”Ÿä¿¡æ¯
onMounted(async () => {
  const studentIdParam = route.params.studentId || route.query.studentId
  const studentId = Array.isArray(studentIdParam)
    ? studentIdParam[0]
    : studentIdParam

  if (studentId && typeof studentId === 'string') {
    const studentIdNum = parseInt(studentId, 10)
    if (!isNaN(studentIdNum)) {
      const result = db.get('SELECT * FROM student WHERE id = ?', [studentIdNum])
      if (!result) {
        ElMessage.error('å­¦ç”Ÿä¸å­˜åœ¨')
        router.push('/assessment/select-student')
        return
      }
      // éªŒè¯å¿…éœ€å­—æ®µ
      if (!result.gender) {
        ElMessage.error('å­¦ç”Ÿä¿¡æ¯ä¸å®Œæ•´ï¼šç¼ºå°‘æ€§åˆ«ä¿¡æ¯')
        router.push('/assessment/select-student')
        return
      }
      if (!result.birthday) {
        ElMessage.error('å­¦ç”Ÿä¿¡æ¯ä¸å®Œæ•´ï¼šç¼ºå°‘ç”Ÿæ—¥ä¿¡æ¯')
        router.push('/assessment/select-student')
        return
      }
      student.value = result
    }
  } else {
    ElMessage.error('æ— æ•ˆçš„å­¦ç”ŸID')
    router.push('/assessment/select-student')
  }
})

onUnmounted(() => {
  speechSynthesis.cancel()
})
</script>

<style scoped>
.conners-psq-assessment {
  max-width: 1000px;
  margin: 0 auto;
  padding: 20px;
}

.welcome-content h2 {
  text-align: center;
  color: #409EFF;
  margin-bottom: 20px;
}

.welcome-intro {
  text-align: center;
  color: #606266;
  margin-bottom: 30px;
  line-height: 1.8;
}

.welcome-sections {
  margin: 30px 0;
}

.welcome-section {
  margin-bottom: 25px;
  padding: 15px;
  background: #f5f7fa;
  border-radius: 8px;
}

.welcome-section h4 {
  margin: 0 0 10px 0;
  color: #303133;
}

.section-icon {
  margin-right: 8px;
}

.welcome-section ul {
  margin: 10px 0;
  padding-left: 20px;
}

.welcome-section li {
  margin: 8px 0;
  color: #606266;
}

.welcome-footer {
  text-align: center;
  color: #909399;
  margin-top: 20px;
}

.assessment-header {
  margin-bottom: 20px;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 20px;
}

.student-info h3 {
  margin: 0 0 10px 0;
}

.info-row span {
  margin-right: 20px;
  color: #606266;
}

.progress-info {
  flex: 1;
  min-width: 300px;
}

.progress-text {
  text-align: center;
  margin-top: 10px;
  color: #909399;
}

.question-card {
  min-height: 400px;
}

.question-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.question-number {
  font-size: 18px;
  font-weight: bold;
  color: #409EFF;
}

.question-dimension {
  padding: 4px 12px;
  background: #ecf5ff;
  color: #409EFF;
  border-radius: 4px;
  font-size: 14px;
}

.question-content {
  margin: 30px 0;
}

.question-title {
  font-size: 20px;
  line-height: 1.8;
  color: #303133;
  margin-bottom: 30px;
}

.question-actions {
  margin-bottom: 30px;
}

.answer-options {
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
}

.answer-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 100px;
}

.option-label {
  font-size: 18px;
  font-weight: bold;
}

.option-desc {
  font-size: 12px;
  color: #909399;
}

.question-nav {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 30px;
}
</style>

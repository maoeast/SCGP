// src/database/csirs-conversion.ts
// CSIRS量表原始分到T分转换表
// 转换表数据来源：docs/儿童感觉统合能力发展评定量表原始分与标准分转换表.xlsx

import type { CSIRSConversionTable, CSIRSEvaluationLevel, CSIRSDimensionType } from '@/types/csirs';

// 原始分到T分转换表 (基于官方常模数据)
// 数组索引对应T分-10，即index=0对应T分10，index=1对应T分11，以此类推
// 数组值是该T分对应的原始分阈值（达到或超过此原始分即可获得该T分）
export const csirsConversionTables: CSIRSConversionTable[] = [
  {
    age_years: 3,
    dimensions: {
      vestibular: [29, 29, 30, 30, 31, 32, 33, 33, 34, 34, 35, 36, 36, 37, 37, 38, 39, 39, 40, 40, 41, 42, 42, 43, 43, 44, 44, 45, 46, 46, 47, 47, 48, 49, 49, 50, 50, 51, 52, 52, 53, 54, 54, 55, 55, 56, 56, 57, 57, 58, 59, 59, 60, 61, 62, 62, 63, 63, 64, 64, 65],
      tactile: [44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105],
      proprioception: [23, 24, 24, 25, 26, 27, 27, 28, 28, 29, 30, 30, 31, 32, 33, 33, 34, 35, 35, 36, 37, 37, 38, 38, 39, 40, 41, 41, 42, 43, 43, 44, 44, 45, 46, 46, 47, 47, 48, 49, 50, 50, 51, 52, 53, 53, 54, 54, 55, 56, 56, 57, 58, 58, 59, 60, 60]
    }
  },
  {
    age_years: 4,
    dimensions: {
      vestibular: [27, 28, 29, 29, 30, 31, 31, 32, 32, 33, 33, 34, 34, 34, 36, 36, 37, 37, 38, 39, 39, 40, 40, 41, 42, 43, 43, 44, 45, 45, 46, 47, 48, 48, 49, 49, 49, 50, 51, 52, 52, 53, 53, 54, 54, 55, 55, 56, 57, 57, 58, 59, 59, 60, 60, 61, 62, 63, 64, 65, 65],
      tactile: [45, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 78, 79, 80, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 97, 98, 99, 100],
      proprioception: [26, 27, 28, 28, 29, 29, 30, 30, 31, 31, 32, 32, 33, 33, 34, 34, 35, 35, 36, 36, 37, 38, 39, 39, 40, 41, 41, 42, 42, 43, 43, 44, 44, 45, 46, 46, 47, 47, 48, 49, 49, 50, 51, 51, 52, 52, 53, 53, 54, 54, 55, 56, 56, 57, 57, 58, 58, 59, 60]
    }
  },
  {
    age_years: 5,
    dimensions: {
      vestibular: [29, 30, 30, 31, 32, 32, 33, 34, 34, 35, 36, 36, 37, 38, 39, 39, 40, 40, 41, 42, 42, 43, 43, 44, 44, 45, 46, 46, 47, 47, 48, 49, 49, 50, 51, 51, 52, 53, 53, 54, 54, 55, 56, 57, 57, 58, 58, 59, 59, 60, 61, 62, 62, 63, 64, 64, 65, 65, 66, 66, 67],
      tactile: [50, 51, 52, 52, 53, 54, 55, 56, 56, 57, 58, 59, 60, 61, 62, 63, 63, 64, 65, 65, 67, 67, 68, 69, 70, 71, 72, 73, 73, 74, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 89, 90, 91, 92, 93, 93, 94, 95, 96, 97, 97, 98, 99, 100, 101],
      proprioception: [24, 25, 26, 27, 27, 28, 28, 29, 29, 30, 31, 32, 33, 33, 34, 34, 35, 36, 37, 37, 38, 38, 39, 39, 40, 41, 42, 43, 43, 44, 44, 45, 45, 46, 47, 47, 48, 48, 49, 49, 50, 51, 52, 53, 53, 54, 54, 55, 56, 56, 57, 57, 58, 59, 59, 60]
    }
  },
  {
    age_years: 6,
    dimensions: {
      vestibular: [30, 30, 31, 32, 33, 34, 34, 35, 35, 36, 37, 37, 38, 38, 39, 40, 40, 41, 42, 42, 43, 44, 45, 45, 46, 47, 48, 49, 49, 50, 50, 50, 51, 52, 53, 54, 55, 55, 56, 56, 57, 58, 59, 59, 60, 60, 61, 62, 62, 63, 64, 64, 65, 65, 66, 67, 68, 69, 69, 70],
      tactile: [51, 52, 53, 54, 55, 56, 57, 58, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 78, 79, 80, 81, 81, 82, 83, 84, 85, 86, 87, 88, 88, 89, 90, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 105],
      proprioception: [31, 31, 32, 32, 33, 33, 34, 34, 35, 35, 36, 36, 37, 37, 38, 38, 39, 39, 40, 40, 41, 41, 42, 42, 43, 43, 44, 44, 45, 45, 46, 46, 47, 47, 48, 49, 50, 50, 51, 51, 52, 52, 53, 53, 54, 54, 55, 55, 56, 57, 57, 57, 58, 58, 59, 59, 60],
      learning: [10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 15, 16, 16, 17, 17, 18, 19, 19, 20, 20, 21, 21, 22, 22, 23, 23, 24, 25, 25, 26, 26, 27, 27, 28, 28, 29, 29, 30, 30, 31, 32, 32, 33, 33, 34, 34, 35, 35, 36, 36, 37, 38, 38, 39, 39, 40]
    }
  },
  {
    age_years: 7,
    dimensions: {
      vestibular: [31, 32, 33, 33, 34, 34, 35, 35, 36, 37, 38, 39, 40, 40, 41, 42, 42, 43, 44, 44, 45, 45, 46, 47, 48, 48, 49, 50, 50, 51, 51, 52, 53, 54, 54, 55, 55, 56, 57, 57, 58, 58, 59, 60, 61, 61, 62, 63, 64, 65, 65, 66, 66, 67, 68, 68, 69, 69, 70, 70],
      tactile: [52, 53, 54, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 74, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 85, 86, 87, 88, 89, 90, 91, 92, 93, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 105],
      proprioception: [27, 28, 29, 30, 30, 31, 32, 32, 33, 33, 34, 34, 35, 35, 36, 36, 37, 38, 39, 39, 40, 40, 41, 42, 43, 43, 44, 44, 45, 45, 46, 47, 48, 48, 49, 49, 50, 51, 52, 52, 53, 53, 54, 54, 55, 55, 56, 56, 57, 57, 58, 58, 59, 59, 60],
      learning: [11, 12, 12, 13, 13, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18, 19, 19, 20, 21, 21, 22, 23, 23, 23, 24, 24, 25, 25, 26, 26, 27, 27, 28, 28, 29, 29, 30, 30, 31, 31, 32, 32, 33, 33, 34, 34, 35, 35, 36, 36, 37, 37, 38, 38, 39, 40, 40]
    }
  },
  {
    age_years: 8,
    dimensions: {
      vestibular: [31, 31, 32, 33, 34, 34, 35, 35, 36, 37, 38, 38, 39, 39, 40, 40, 41, 42, 42, 43, 44, 45, 45, 46, 46, 47, 48, 49, 50, 50, 51, 52, 53, 53, 54, 54, 55, 56, 57, 57, 58, 58, 59, 60, 60, 61, 62, 63, 64, 64, 65, 65, 66, 67, 67, 68, 69, 69, 70, 70],
      tactile: [48, 49, 50, 51, 52, 53, 54, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105],
      proprioception: [21, 22, 22, 23, 23, 24, 25, 26, 27, 28, 28, 29, 30, 31, 32, 32, 33, 34, 34, 35, 36, 36, 37, 38, 39, 39, 40, 41, 41, 42, 43, 44, 44, 45, 46, 46, 47, 48, 49, 50, 51, 52, 52, 53, 54, 55, 56, 57, 57, 58, 58, 59, 59, 60],
      learning: [9, 10, 10, 11, 11, 12, 12, 13, 14, 14, 15, 16, 16, 17, 17, 18, 18, 19, 19, 20, 20, 21, 21, 22, 23, 23, 24, 25, 25, 26, 26, 27, 27, 28, 29, 29, 30, 30, 31, 31, 32, 33, 33, 34, 35, 35, 36, 37, 37, 38, 38, 39, 39, 40, 40]
    }
  },
  {
    age_years: 9,
    dimensions: {
      vestibular: [26, 27, 28, 29, 29, 30, 31, 32, 33, 33, 34, 35, 36, 37, 38, 38, 39, 40, 41, 42, 43, 43, 44, 44, 45, 45, 46, 47, 48, 49, 50, 51, 52, 53, 53, 54, 55, 55, 56, 57, 57, 58, 59, 60, 61, 62, 63, 63, 64, 65, 65, 66, 67, 67, 68, 69, 70],
      tactile: [45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105],
      proprioception: [23, 24, 25, 26, 27, 27, 28, 28, 29, 30, 31, 32, 32, 33, 34, 34, 35, 35, 36, 37, 37, 38, 39, 39, 40, 41, 42, 42, 43, 44, 44, 45, 46, 46, 47, 48, 48, 49, 50, 51, 51, 52, 52, 53, 54, 54, 55, 56, 56, 57, 57, 58, 59, 60],
      learning: [10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 16, 16, 17, 17, 18, 18, 19, 19, 20, 21, 21, 22, 22, 23, 23, 24, 24, 25, 25, 26, 26, 27, 27, 28, 28, 29, 30, 31, 31, 32, 32, 33, 33, 34, 34, 35, 36, 36, 37, 37, 38, 38, 39, 39, 40]
    }
  },
  {
    age_years: 10,
    dimensions: {
      vestibular: [31, 32, 33, 33, 34, 34, 35, 35, 36, 37, 38, 38, 39, 40, 41, 41, 42, 43, 44, 44, 45, 46, 46, 47, 48, 48, 49, 50, 51, 52, 52, 53, 53, 54, 55, 55, 56, 57, 57, 58, 59, 59, 60, 61, 62, 62, 63, 64, 64, 65, 66, 67, 67, 68, 69, 70, 70],
      tactile: [49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 91, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105],
      proprioception: [26, 27, 27, 28, 28, 29, 29, 30, 31, 31, 32, 33, 34, 34, 35, 36, 36, 37, 37, 38, 39, 39, 40, 41, 41, 42, 43, 43, 44, 44, 45, 46, 47, 47, 48, 48, 49, 49, 50, 51, 51, 52, 52, 53, 54, 54, 55, 56, 56, 57, 57, 58, 59, 59, 60],
      learning: [8, 8, 8, 9, 9, 9, 9, 10, 11, 11, 12, 12, 13, 14, 14, 15, 16, 16, 17, 18, 18, 19, 19, 20, 21, 21, 22, 22, 23, 24, 24, 25, 26, 26, 27, 28, 28, 29, 30, 31, 31, 32, 32, 33, 33, 34, 35, 36, 36, 37, 37, 38, 39, 39, 40]
    }
    // 注意：Excel中没有executive维度的转换表数据，该维度不计入总分
  },
  {
    age_years: 11,
    dimensions: {
      vestibular: [30, 31, 31, 32, 33, 33, 34, 35, 35, 36, 37, 38, 38, 39, 40, 41, 42, 42, 43, 43, 44, 45, 46, 47, 47, 48, 49, 50, 51, 52, 52, 53, 54, 55, 56, 57, 57, 58, 58, 59, 60, 61, 62, 62, 63, 63, 64, 65, 65, 66, 67, 67, 68, 68, 69, 70],
      tactile: [47, 48, 49, 50, 51, 52, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105],
      proprioception: [27, 28, 28, 29, 30, 31, 31, 32, 32, 33, 34, 34, 35, 36, 36, 37, 38, 38, 39, 39, 40, 41, 42, 42, 43, 44, 44, 45, 45, 46, 47, 47, 48, 48, 49, 49, 50, 51, 51, 52, 52, 53, 54, 54, 55, 56, 56, 57, 58, 58, 59, 59, 60],
      learning: [13, 13, 14, 15, 15, 16, 16, 17, 17, 18, 18, 19, 19, 20, 20, 21, 21, 22, 22, 23, 23, 24, 24, 25, 25, 26, 26, 27, 27, 28, 28, 29, 29, 30, 31, 31, 32, 32, 33, 33, 34, 34, 35, 35, 36, 36, 37, 37, 38, 38, 39, 39, 40]
    }
    // 注意：Excel中没有executive维度的转换表数据，该维度不计入总分
  },
  {
    age_years: 12,
    dimensions: {
      vestibular: [37, 37, 38, 38, 39, 40, 41, 41, 42, 42, 43, 44, 44, 45, 45, 46, 46, 47, 47, 48, 49, 49, 50, 51, 51, 52, 52, 53, 54, 54, 55, 56, 56, 57, 58, 58, 59, 59, 60, 61, 61, 62, 62, 63, 63, 64, 64, 65, 66, 66, 67, 67, 68, 68, 69, 69, 70],
      tactile: [51, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105],
      proprioception: [27, 28, 28, 29, 30, 31, 31, 32, 33, 33, 34, 34, 35, 36, 36, 37, 38, 38, 39, 39, 40, 41, 41, 42, 43, 43, 44, 44, 45, 46, 46, 47, 48, 48, 49, 49, 50, 51, 51, 52, 52, 53, 54, 54, 55, 56, 56, 57, 58, 58, 59, 59, 60],
      learning: [12, 13, 13, 14, 14, 15, 16, 16, 17, 17, 18, 18, 19, 19, 20, 20, 21, 21, 22, 22, 23, 23, 24, 24, 25, 25, 26, 26, 27, 27, 28, 28, 29, 29, 30, 31, 31, 32, 32, 33, 33, 34, 34, 35, 36, 36, 37, 37, 38, 38, 39, 39, 40]
    }
    // 注意：Excel文件中12岁的executive维度数据缺失（Excel只有38列，12岁需要列38存储executive数据）
  }
];

// 等级评定标准
export const csirsEvaluationLevels: CSIRSEvaluationLevel[] = [
  { min_t: 0, max_t: 29, level: '严重偏低', description: '需要专业干预和支持', color: '#F56C6C' },
  { min_t: 30, max_t: 39, level: '偏低', description: '建议进行感觉统合训练', color: '#E6A23C' },
  { min_t: 40, max_t: 60, level: '正常', description: '感觉统合能力发展良好', color: '#67C23A' },
  { min_t: 61, max_t: 70, level: '优秀', description: '感觉统合能力发展优秀', color: '#409EFF' },
  { min_t: 71, max_t: 100, level: '非常优秀', description: '感觉统合能力发展非常突出', color: '#909399' }
];

// 根据原始分计算T分
export function calculateTScore(rawScore: number, ageYears: number, dimension: CSIRSDimensionType): number {
  // Input validation
  if (rawScore < 0) {
    console.warn(`calculateTScore: Invalid raw score ${rawScore}, using 0`);
    rawScore = 0;
  }

  const table = csirsConversionTables.find(t => t.age_years === ageYears);
  if (!table) {
    console.warn(`calculateTScore: No conversion table for age ${ageYears}, using default 50`);
    return 50; // 默认值
  }

  const scores = table.dimensions[dimension];
  if (!scores || !Array.isArray(scores)) {
    console.warn(`calculateTScore: Dimension ${dimension} not available for age ${ageYears}, using default 50`);
    return 50;
  }

  // 转换表说明：数组索引对应T分-10（index=0对应T分10）
  // 数组值是该T分对应的原始分阈值
  // 查找原始分对应的最高T分（原始分越高，T分越高）
  for (let i = scores.length - 1; i >= 0; i--) {
    if (rawScore >= scores[i]) {
      return 10 + i;
    }
  }

  // 原始分低于最小值，返回最低T分
  return 10;
}

// 根据T分获取等级
export function getEvaluationLevel(tScore: number): CSIRSEvaluationLevel {
  const level = csirsEvaluationLevels.find(l => tScore >= l.min_t && tScore <= l.max_t);
  return level || csirsEvaluationLevels[2]; // 默认返回正常
}

// 获取转换表
export function getConversionTable(ageYears: number): CSIRSConversionTable | null {
  return csirsConversionTables.find(t => t.age_years === ageYears) || null;
}

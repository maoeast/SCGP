# 生活自理适应综合训练系统 - 开发文档

## 项目概述

本项目是一个为特殊教育学校设计的电子化评估和训练系统，帮助学生提高生活自理能力。系统包含 S-M 量表和 WeeFIM 量表的电子化评估、个性化训练计划生成、以及训练任务执行等功能。

### 技术栈
- **前端框架**：Vue 3 + TypeScript + Vite
- **路由管理**：Vue Router
- **状态管理**：Pinia
- **数据库**：SQL.js + IndexedDB（主存储）、localStorage（激活状态）
- **UI 框架**：自定义 CSS + Font Awesome 图标
- **桌面应用**：Electron（已集成）

### 项目结构
```
self-care-ats/
├── src/
│   ├── assets/          # 静态资源
│   ├── components/      # 公共组件
│   ├── database/        # 数据库相关
│   │   ├── api.ts      # 数据库 API
│   │   ├── init.ts     # 数据库初始化
│   │   ├── init-training-data.ts # 训练数据初始化
│   │   ├── sql-wrapper.ts # SQL.js数据库包装器
│   │   ├── indexeddb-storage.ts # IndexedDB存储管理
│   │   └── mock-data.ts # Mock 数据
│   ├── router/          # 路由配置
│   ├── stores/          # Pinia 状态管理
│   │   ├── auth.ts     # 认证状态
│   │   ├── student.ts  # 学生状态
│   │   ├── task.ts     # 训练任务状态
│   │   └── assessment.ts # 评估状态
│   ├── utils/           # 工具函数
│   │   ├── backup.ts   # 备份恢复工具
│   │   ├── crypto.ts   # 加密工具
│   │   ├── license-manager.ts # 激活管理
│   │   ├── activation-manager.ts # IndexedDB激活管理
│   │   ├── resource-manager.ts # 资源文件管理
│   │   └── resource-importer.ts # 资源批量导入
│   ├── views/           # 页面组件
│   │   ├── Login.vue    # 登录页
│   │   ├── Activation.vue # 激活页
│   │   ├── ActivationAdmin.vue # 激活管理页
│   │   ├── Layout.vue   # 主布局
│   │   ├── Dashboard.vue # 仪表板
│   │   ├── Students.vue # 学生管理
│   │   ├── Resources.vue # 资源库
│   │   ├── System.vue   # 系统管理
│   │   └── ...
│   ├── electron/        # Electron相关
│   │   ├── main.js     # Electron主进程
│   │   └── preload.js  # 预加载脚本
│   ├── App.vue           # 根组件
│   └── main.ts           # 入口文件
└── ...
```

## 第一阶段：基础框架搭建（已完成）

### 1. 项目初始化
- ✅ 使用 Vite 初始化 Vue 3 + TypeScript 项目
- ✅ 配置基础开发环境和构建流程
- ✅ 安装必要依赖（crypto-js, uuid, sql.js等）

### 2. 数据库设计
- ✅ 设计完整的数据库 schema（20个表）
  - 用户表（user）
  - 学生表（student）
  - S-M 量表相关表（6个）
  - WeeFIM 量表相关表（4个）
  - 训练任务相关表（6个）
  - 系统管理表（3个）

### 3. 数据库实现
- ✅ **SQL.js集成**：成功替代Mock Database
- ✅ **双层存储架构**：
  - SQL.js作为内存数据库，提供SQL查询能力
  - IndexedDB作为持久化存储，自动同步数据
  - 激活状态仍使用localStorage加密存储

### 4. 路由系统
- ✅ Vue Router 配置
- ✅ 路由守卫实现
- ✅ 权限控制逻辑
- ✅ 激活状态检查

### 5. 状态管理
- ✅ Pinia store 配置
- ✅ Auth store（认证和激活）
- ✅ Student store（学生管理）
- ✅ Task store（训练任务管理）
- ✅ Assessment store（评估管理）

## 第二阶段：核心系统模块（已完成）

### 1. 用户认证系统
#### 密码加密存储
```typescript
// src/utils/crypto.ts
export function encryptPassword(password: string, salt?: string): { hash: string; salt: string }
export function verifyPassword(password: string, hash: string): boolean
```
- ✅ AES-256 加密实现
- ✅ PBKDF2 密钥派生
- ✅ 向后兼容的验证机制

### 2. 激活系统
#### 激活管理器升级
- ✅ **localStorage版本**：`license-manager.ts`
  - 基于 Canvas 的机器指纹
  - AES 加密 + HMAC 防篡改
- ✅ **IndexedDB版本**：`activation-manager.ts`
  - 更安全的存储方式
  - 支持激活历史记录
  - 激活管理员界面

### 3. 学生管理模块
#### 功能实现
- ✅ 学生列表展示
- ✅ 添加学生功能（支持摄像头拍照）
- ✅ 编辑学生信息
- ✅ 删除学生
- ✅ 学生搜索筛选
- ✅ 批量导入（UI 已完成）
- ✅ 文字头像自动生成
- ✅ 学生详情页面（显示评估记录、训练记录等）

#### API 接口
```typescript
// src/database/api.ts
export class StudentAPI extends DatabaseAPI {
  getAllStudents(): any[]
  addStudent(student: any): number
  updateStudent(id: number, student: any): boolean
  deleteStudent(id: number): boolean
  searchStudents(keyword: string): any[]
}
```

### 4. 数据备份与恢复
#### 备份管理器
```typescript
// src/utils/backup.ts
export class BackupManager {
  async exportData(): Promise<string>      // 导出数据
  async importData(data: string): Promise<void>  // 导入数据
  async downloadBackup(filename?: string): Promise<void>
}
```

#### 功能特性
- ✅ 数据导出为加密文件
- ✅ 从文件恢复数据
- ✅ 备份文件信息预览
- ✅ 完整的系统管理界面

### 5. 资源库模块
#### 功能实现
- ✅ 完整的资源管理CRUD操作
- ✅ 6大资源分类管理
- ✅ 文件预览机制（PDF、Office、图片、视频、音频）
- ✅ 本地文件系统集成（Electron）
- ✅ 批量导入功能（CSV模板导入）
- ✅ 资源文件存储管理

#### 关键文件
- `src/database/api.ts` - ResourceAPI类
- `src/views/Resources.vue` - 资源库主界面
- `src/components/FilePreview.vue` - 文件预览组件
- `src/utils/resource-manager.ts` - 本地文件管理
- `resource-import-template.csv` - 批量导入模板

## 第三阶段：评估模块开发（已完成）

### 1. 数据准备完成
✅ **S-M量表数据**：
- 成功导入官方CSV文件中的132道题目
- 6个维度：交往、作业、运动能力、独立生活能力、自我管理、集体活动
- 7个年龄阶段：6个月-10岁6个月以上
- 官方粗分-标准分换算表（12个年龄段）
- 9级评定标准：极重度、重度、中度、轻度、边缘、正常、高常、优秀、非常优秀

✅ **WeeFIM量表数据**：
- 18道题目，6个分类
- 2大领域：运动功能（13题）、认知功能（5题）
- 1-7分评分系统
- 7级功能独立性评定
- 完整的评语建议系统

### 2. 评估页面功能实现
✅ **完整的评估流程**：
- 评估选择页面 → 选择S-M量表或WeeFIM量表
- 学生选择页面 → 搜索并选择要评估的学生，支持快速添加
- 评估执行页面 → 根据年龄阶段动态筛选题目，支持语音朗读和断点续做
- 评估结果展示 → 自动计算评分和等级

✅ **核心功能实现**：
- 语音合成API（Web Speech API）
- 断点续做（临时数据保存到localStorage，完成后存储到IndexedDB）
- S-M粗分计算算法（基础分+通过题数）
- WeeFIM评分标准（1-7分制）

### 3. 报告系统
✅ **报告导出功能**：
- PDF/Word报告导出
- 统一报告模板（SMReportTemplate, WeeFIMReportTemplate）
- 评估结果说明、训练建议、家庭指导
- 自动生成IEP目标建议

✅ **数据校准**：
- S-M量表换算表手动校准（与官方CSV一致）
- WeeFIM独立性评定显示修复
- 边界值和重叠范围处理

## 第四阶段：训练模块开发（已完成）

### 1. 训练任务管理
✅ **训练任务系统**：
- 6大能力类别（饮食、穿着、如厕、清洁、睡眠、家居）
- 训练任务创建、编辑、删除
- 训练步骤配置（图片、视频、音频、文字）
- 移除难度级别区分，简化为单一训练步骤

✅ **训练执行界面**：
- 全屏训练模式
- 媒体内容展示（图片/视频切换）
- 语音播放控制
- 键盘快捷键支持
- 训练记录采集（得分、用时、错误类型）

### 2. 训练计划系统
✅ **训练计划管理**：
- 创建个性化训练计划
- 计划任务管理
- 计划执行跟踪
- 训练进度统计

### 3. UI优化
✅ **界面美化**：
- 渐变色按钮设计
- Font Awesome图标集成
- 响应式布局
- 悬停动画效果

## 第五阶段：系统集成与数据整合（2025年12月17日）

### 1. 仪表盘数据整合
✅ **Dashboard真实数据展示**：
- 替换所有模拟数据为真实数据库信息
- 统计卡片实时计算：
  - 学生总数
  - 待评估学生数
  - 今日训练次数
  - 已完成计划数
- 最近添加的学生列表
- 动态待办事项
- 各能力类别训练进度计算

### 2. 关键修复记录
✅ **任务编辑保存问题**：
- 修复NOT NULL约束错误（score和description字段）
- 修复task_id未定义错误（查询task_level表获取task_id）
- 正确保存训练步骤数据

✅ **训练数据刷新问题**：
- 添加visibilitychange事件监听器
- 完成训练后自动刷新任务列表
- 添加手动刷新按钮

✅ **训练计划执行问题**：
- 添加getTrainingPlanDetail和getTrainingPlanTasks API方法
- 修复执行按钮无反应问题
- 正确加载计划任务列表

✅ **新任务训练界面空白**：
- 添加任务级别和步骤的主动加载
- 确保新创建的任务能够正常执行

### 3. 数据库优化
✅ **API完善**：
```typescript
// 训练计划相关API
async getTrainingPlanDetail(planId: number): Promise<any>
async getTrainingPlanTasks(planId: number): Promise<any[]>

// 任务保存相关修复
saveTaskSteps(levelId: number, steps: any[]): void {
  // 获取level对应的task_id
  const level = this.queryOne('SELECT task_id FROM task_level WHERE id = ?', [levelId]);
  // 插入步骤时正确设置task_id
}
```

## 技术架构要点

### 1. 存储架构
```
┌─────────────────┐     ┌──────────────┐     ┌──────────────┐
│   应用程序      │────▶│   SQL.js     │────▶│ IndexedDB    │
│                 │     │  内存数据库   │     │  持久化存储   │
└─────────────────┘     └──────────────┘     └──────────────┘
         │                       │                      │
         ▼                       ▼                      ▼
┌─────────────────┐     ┌──────────────┐     ┌──────────────┐
│   localStorage  │     │  实时查询    │     │   数据持久化  │
│  （激活状态）    │     │  事务处理    │     │   离线支持   │
└─────────────────┘     └──────────────┘     └──────────────┘
```

### 2. 激活系统流程
```
首次启动 → 生成机器指纹 → 7天试用期 → 需要激活
    │                                    │
    ▼                                    ▼
激活失败 → 限制使用 ←────── 验证激活码 ←─ 输入激活码
    │                                    │
    └─────────────→ 使用完整功能 ←────────┘
```

### 3. 数据同步机制
```
用户操作 → SQL.js执行 → 内存数据变更 → 自动同步 → IndexedDB存储
    ↑                                              ↓
应用重启 ←── IndexedDB加载 ←── 数据持久化 ←───────┘
```

## 已知问题和解决方案

### 1. 已解决的问题
- ✅ SQL.js导入失败 → 使用动态import解决
- ✅ 训练任务编辑不保存 → 修复NOT NULL约束
- ✅ 训练完成后列表为空 → 添加刷新机制
- ✅ 新任务训练界面空白 → 主动加载数据
- ✅ Dashboard模拟数据 → 替换为真实数据
- ✅ 资源库文件管理 → 集成Electron本地文件系统
- ✅ 激活系统复杂 → 提供双重存储方案

### 2. 注意事项
- **数据一致性**：SQL.js和IndexedDB之间的同步是自动的，但在大量数据操作时建议手动调用保存
- **激活状态**：存储在localStorage中的激活数据是加密的，但清除浏览器数据会导致需要重新激活
- **文件路径**：Electron环境下使用本地文件路径，Web环境下使用相对路径

## 开发指南

### 1. 环境要求
- Node.js >= 16
- npm >= 8
- 现代浏览器（支持 ES2020+）

### 2. 开发命令
```bash
# 安装依赖
npm install

# 启动开发服务器（带智能端口管理）
npm run dev

# 构建生产版本
npm run build

# 构建Electron应用
npm run build:electron
```

### 3. 调试技巧
- 使用 Vue DevTools 调试组件状态
- 业务数据存储在 IndexedDB 中，可通过浏览器开发者工具查看
- 激活状态在 localStorage 中查看（加密存储）
- 训练媒体文件在 `assets/resources/` 目录下按分类组织

### 4. 代码规范
- 使用 TypeScript 进行类型检查
- 遵循 Vue 3 Composition API 最佳实践
- 使用 ESLint 和 Prettier 保持代码风格
- 数据库操作使用事务确保一致性

## 未来规划

### 1. 26项生活自理评估量表（规划中）
- 基于训练数据的自动评估
- 6大领域26项生活技能评估
- 0-4五级评分制
- IEP目标智能推荐

### 2. 高级功能
- 训练效果可视化分析
- 家长端移动应用
- 云端数据同步
- 多校区数据管理

## 总结

目前系统已完成核心功能开发，包括：
- 完整的评估系统（S-M、WeeFIM）
- 训练任务管理和执行
- 资源库文件管理
- 学生信息管理
- 数据备份恢复
- 激活授权系统
- 仪表盘数据整合

系统已具备投入使用的基础功能，后续可根据实际使用反馈进行优化和扩展。

**系统访问地址**：http://localhost:5173/
**默认账号**：admin / admin123

**主要特性**：
- 完整的评估和训练体系
- 真实数据驱动仪表盘
- 本地文件系统集成
- 灵活的激活机制
- 完善的数据管理

---
*文档更新时间：2025年12月17日*
*版本：v2.0*
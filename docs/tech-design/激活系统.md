## 激活系统架构

### 设计理念

本应用采用**试用期 + 离线激活**的双模式机制，适合教育场景的纯离线部署需求。激活码采用 RSA 数字签名 + AES 加密存储，确保安全性与防篡改。

### 核心模块

#### 1. 激活码生成器（`generate-license.js`）

**作用**：服务端工具，用于生成试用码和正式激活码

**功能**：
- 生成 RSA-2048 密钥对（首次运行）
- 生成试用激活码（7 天免费，不绑定机器）
- 生成正式激活码（绑定机器码，支持限时或永久）
- 使用 RSA 私钥对激活数据进行数字签名

**使用方法**：

```bash
# 生成试用码
node generate-license.js --trial

# 生成正式激活码（365天）
node generate-license.js --machine <机器码> --days 365

# 生成永久激活码
node generate-license.js --machine <机器码> --permanent
```

**关键代码片段**：

```javascript
// 数据结构（字段缩写以减少激活码长度）
const licenseData = {
    t: 'full',              // type: 激活类型（trial/full）
    v: '1.0',               // version: 版本号
    m: '067D30ECBD218C95',  // machineId: 机器码
    c: Date.now(),          // createdAt: 创建时间戳
    e: null,                // expireAt: 过期时间（null=永久）
    p: true                 // permanent: 是否永久
};

// RSA 签名流程
const dataBuffer = Buffer.from(JSON.stringify(licenseData), 'utf8');
const signature = crypto.sign('sha256', dataBuffer, {
    key: privateKey,
    padding: crypto.constants.RSA_PKCS1_PADDING
});

// 组合格式：[4字节数据长度] + [JSON数据] + [RSA签名]
const lengthBuffer = Buffer.allocUnsafe(4);
lengthBuffer.writeUInt32BE(dataBuffer.length, 0);
const combined = Buffer.concat([lengthBuffer, dataBuffer, signature]);

// Base64 编码后格式化
const base64 = combined.toString('base64');
const formatted = 'SPED-' + base64.match(/.{1,5}/g).join('-');
```

**激活码格式示例**：

```
SPED-AAAAU-XsidC-I6ImZ-1bGwi-LCJ2I-joiMS-4wIiw-ibSI6-IjA2N-0QzME-...
```

- 前缀：`SPED-`
- 分组：每 5 个字符用 `-` 分隔
- 长度：约 456 字符（包含签名）

#### 2. 激活验证模块（`license-manager.js`）

**作用**：客户端模块，验证激活码并管理激活状态

**核心功能**：

##### 机器指纹获取（宽松模式）

```javascript
function getMachineFingerprint() {
    // 使用 node-machine-id 获取稳定的机器ID（基于 CPU + 主板）
    const machineId = machineIdSync({ original: true });
    
    // SHA256 哈希后取前 16 位
    const hash = crypto.createHash('sha256');
    hash.update(machineId);
    return hash.digest('hex').substring(0, 16).toUpperCase();
    // 示例：067D30ECBD218C95
}
```

**宽松模式容忍度**：60%（允许更换内存等非核心硬件）

```javascript
function calculateSimilarity(code1, code2) {
    let matches = 0;
    const len = Math.min(code1.length, code2.length);
    for (let i = 0; i < len; i++) {
        if (code1[i] === code2[i]) matches++;
    }
    return matches / len; // >= 0.6 即通过验证
}
```

##### RSA 签名验证流程

```javascript
function decryptLicenseKey(licenseKey) {
    // 1. 反格式化：移除 SPED- 前缀和连字符
    const base64Data = licenseKey.replace(/^SPED-/i, '').replace(/-/g, '');
    
    // 2. Base64 解码
    const combined = Buffer.from(base64Data, 'base64');
    
    // 3. 读取前 4 字节获取数据长度
    const dataLength = combined.readUInt32BE(0);
    const dataBuffer = combined.slice(4, 4 + dataLength);
    const signature = combined.slice(4 + dataLength);
    
    // 4. 使用 RSA 公钥验证签名
    const isValid = crypto.verify('sha256', dataBuffer, {
        key: publicKey,
        padding: crypto.constants.RSA_PKCS1_PADDING
    }, signature);
    
    if (!isValid) {
        throw new Error('激活码签名验证失败');
    }
    
    // 5. 解析 JSON 数据并转换字段
    const parsed = JSON.parse(dataBuffer.toString('utf8'));
    return {
        type: parsed.t,
        version: parsed.v,
        machineId: parsed.m,
        createdAt: parsed.c,
        expireAt: parsed.e,
        permanent: parsed.p
    };
}
```

##### AES 加密存储机制

激活成功后，使用 AES-256 加密存储到本地：

```javascript
function encryptActivationData(data) {
    // 1. AES 加密
    const jsonStr = JSON.stringify(data);
    const encrypted = CryptoJS.AES.encrypt(jsonStr, AES_SECRET).toString();
    
    // 2. HMAC 签名防篡改
    const hmac = CryptoJS.HmacSHA256(encrypted, HMAC_SECRET).toString();
    
    return {
        data: encrypted,
        signature: hmac
    };
}
```

**存储位置**（使用 electron-store）：

```
Windows: C:\Users\<用户名>\AppData\Roaming\special-edu-safe\license-data.json
macOS: ~/Library/Application Support/special-edu-safe/license-data.json
Linux: ~/.config/special-edu-safe/license-data.json
```

**存储内容**（加密后）：

```json
{
  "activation": {
    "data": "U2FsdGVkX1...",  // AES 加密后的激活数据
    "signature": "a3f2e1..."  // HMAC-SHA256 签名
  },
  "firstRun": 1732089715408  // 试用期开始时间戳
}
```

##### HMAC 防篡改校验

每次读取激活数据时验证 HMAC 签名：

```javascript
function decryptActivationData(encryptedObj) {
    // 1. 验证 HMAC 签名
    const expectedHmac = CryptoJS.HmacSHA256(encryptedObj.data, HMAC_SECRET).toString();
    if (expectedHmac !== encryptedObj.signature) {
        console.error('激活数据已被篡改！');
        return null;
    }
    
    // 2. AES 解密
    const decrypted = CryptoJS.AES.decrypt(encryptedObj.data, AES_SECRET);
    const jsonStr = decrypted.toString(CryptoJS.enc.Utf8);
    return JSON.parse(jsonStr);
}
```

#### 3. 试用期逻辑处理

**试用期管理**：

```javascript
function checkTrialStatus() {
    const firstRun = licenseStore.get('firstRun');
    const now = Date.now();
    
    if (!firstRun) {
        // 首次运行，记录开始时间
        licenseStore.set('firstRun', now);
        return {
            activated: false,
            type: 'trial',
            message: '欢迎使用！您有7天免费试用期',
            daysRemaining: 7
        };
    }
    
    const trialExpireAt = firstRun + 7 * 24 * 60 * 60 * 1000;
    const daysRemaining = Math.ceil((trialExpireAt - now) / (24 * 60 * 60 * 1000));
    
    if (now < trialExpireAt) {
        return {
            activated: false,
            type: 'trial',
            message: `试用期剩余 ${daysRemaining} 天`,
            daysRemaining: daysRemaining
        };
    } else {
        return {
            activated: false,
            type: 'trial_expired',
            message: '试用期已结束，请激活后继续使用',
            daysRemaining: 0
        };
    }
}
```

**应用启动时检查**：

```javascript
// App.vue - onMounted
const checkActivationStatus = async () => {
    const status = await window.electronAPI.getActivationStatus();
    activationStatus.value = status;
    
    // 未激活或试用期，显示激活对话框
    if (!status.activated) {
        setTimeout(() => {
            showActivationDialog.value = true;
        }, 500);
    }
};
```

**试用期内可跳过激活**：

```javascript
// ActivationDialog.vue
const canSkip = computed(() => {
    return props.activationStatus.type === 'trial' && 
           props.activationStatus.daysRemaining > 0;
});
```

### IPC 通信接口

```javascript
// preload.js
contextBridge.exposeInMainWorld('electronAPI', {
    // 获取机器码
    getMachineId: () => ipcRenderer.invoke('get-machine-id'),
    
    // 验证激活码
    verifyLicense: (licenseKey) => ipcRenderer.invoke('verify-license', licenseKey),
    
    // 获取激活状态
    getActivationStatus: () => ipcRenderer.invoke('get-activation-status')
});

// main.js
ipcMain.handle('get-machine-id', async () => {
    const machineId = licenseManager.getMachineFingerprint();
    return { success: true, machineId };
});

ipcMain.handle('verify-license', async (event, licenseKey) => {
    return licenseManager.verifyLicenseKey(licenseKey);
});

ipcMain.handle('get-activation-status', async () => {
    return licenseManager.getActivationStatus();
});
```

### 安全配置文件

**公钥文件**（`public-key.pem`）：

```
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
-----END PUBLIC KEY-----
```

**密钥管理**：
- 私钥（`.keys/private.pem`）：仅服务端保管，用于生成激活码
- 公钥（`public-key.pem`）：打包到客户端，用于验证激活码

### 激活流程图

```
用户首次启动应用
  ↓
检查激活状态
  ↓
┌─────────────────┬─────────────────┬─────────────────┐
│  已激活且有效    │    试用期内     │   试用期已过期   │
├─────────────────┼─────────────────┼─────────────────┤
│  正常使用       │ 显示激活对话框   │ 显示激活对话框   │
│                │ （可跳过）       │ （不可跳过）     │
└─────────────────┴─────────────────┴─────────────────┘
                        ↓
                  用户输入激活码
                        ↓
              反格式化 → Base64解码
                        ↓
               分离数据和RSA签名
                        ↓
              ┌────────────────┐
              │  RSA公钥验证   │
              └────────────────┘
                ↓           ↓
              成功         失败
                ↓           ↓
          验证机器码     提示错误
          匹配度60%
                ↓
          检查过期时间
                ↓
        AES加密存储到本地
                ↓
          添加HMAC签名
                ↓
            激活成功
```

### 关键配置常量

```javascript
// license-manager.js
const AES_SECRET = 'SPED-SAFE-EDU-2025-SECRET-KEY';   // AES加密密钥
const HMAC_SECRET = 'SPED-SAFE-EDU-2025-HMAC-KEY';    // HMAC签名密钥
const TOLERANCE_LEVEL = 0.6;                           // 机器码相似度容忍度
const PUBLIC_KEY_PATH = path.join(__dirname, 'public-key.pem');

// generate-license.js
const RSA_KEY_SIZE = 2048;                             // RSA密钥长度
const LICENSE_VERSION = '1.0';                         // 激活码版本
const KEY_DIR = path.join(__dirname, '.keys');         // 密钥存储目录
```
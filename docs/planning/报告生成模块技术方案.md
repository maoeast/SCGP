# 报告生成模块技术方案

## 文档信息
- **创建日期**: 2025-12-25
- **文档状态**: 待实施
- **优先级**: P2 (中期优化)

---

## 一、现状分析

### 1.1 现有报告导出功能

项目已实现两个量表的评估报告导出功能:

| 量表类型 | 报告页面 | PDF导出方法 | Word导出方法 |
|---------|---------|------------|-------------|
| S-M量表 | `sm/Report.vue` | `printHelper.ts` - `exportToPDFSimple()` | `exportUtils.ts` - `exportToWord()` |
| WeeFIM量表 | `weefim/Report.vue` | `simpleReportPrinter.ts` - `exportSimpleReport()` | `exportUtils.ts` - `exportToWord()` |

### 1.2 报告模板特点

#### S-M量表报告 (`sm/Report.vue`)
- **完整信息**: 学生信息、粗分、标准分、等级、雷达图、各维度得分、详细评估结果、训练建议、签名
- **数据可视化**: ECharts雷达图展示6大能力维度
- **样式**: Element Plus卡片式布局
- **打印优化**: `@media print` 样式适配

#### WeeFIM量表报告 (`weefim/Report.vue`)
- **完整信息**: 学生信息、总分、运动/认知功能分、独立性等级、各领域详情、雷达图、康复建议、专业建议
- **数据可视化**: ECharts雷达图展示6大领域
- **样式**: Element Plus卡片式布局
- **打印优化**: `@media print` 样式适配

---

## 二、两种PDF导出方案对比

### 2.1 printHelper.ts - exportToPDFSimple (S-M量表使用)

#### 技术实现
```typescript
// 核心流程
1. 克隆报告DOM元素
2. 使用html2canvas将ECharts图表转换为PNG图片
3. 创建新窗口
4. 写入处理后的HTML + 完整样式
5. 调用浏览器打印功能
```

#### 优点 ✅
- **保留原始样式**: 完全复刻页面视觉效果
- **图表真实**: ECharts雷达图转PNG,视觉效果好
- **样式丰富**: 使用Element Plus组件样式
- **所见即所得**: 导出效果和页面显示一致

#### 缺点 ❌
- **依赖html2canvas**: 需要额外依赖库(约170KB)
- **性能开销**: 图表转图片需要时间
- **弹窗问题**: 依赖`window.open()`,可能被浏览器阻止
- **代码复杂**: 需要处理DOM克隆、图表转换等逻辑

#### 适用场景
- 正式报告导出
- 需要高质量图表展示
- 用户对报告专业性要求高

---

### 2.2 simpleReportPrinter.ts - exportSimpleReport (WeeFIM量表使用)

#### 技术实现
```typescript
// 核心流程
1. 手工编写HTML模板字符串
2. 雷达图用进度条替代(不转换图表)
3. 使用纯CSS样式(不依赖Element Plus)
4. 创建新窗口
5. 输出纯文本HTML
```

#### 优点 ✅
- **轻量简洁**: 无需html2canvas等重型依赖
- **性能好**: 纯文本HTML,生成速度快
- **可控性强**: 完全掌控输出格式
- **兼容性好**: 不依赖复杂组件

#### 缺点 ❌
- **失去雷达图**: 只能用进度条代替,视觉效果大打折扣
- **样式单一**: 无法复用页面现有样式
- **维护成本**: 需要单独维护HTML模板
- **数据限制**: 需要提前传入所有数据

#### 适用场景
- 快速导出/预览
- 低配设备或浏览器
- 不需要图表的场景

---

## 三、技术方案建议

### 3.1 推荐方案: 统一使用 printHelper.ts

**理由**:
1. **雷达图是评估报告的核心**
   - S-M和WeeFIM量表都依赖雷达图直观展示能力分布
   - 特殊教育学校老师更看重图表展示
   - 进度条无法替代雷达图的专业性

2. **用户体验更好**
   - 导出PDF和页面看到的内容一致(所见即所得)
   - 适合正式报告归档和打印

3. **技术权衡**
   - html2canvas性能开销可接受(单次操作)
   - 弹窗问题已通过用户提示解决
   - 复杂度换来更好的效果值得

### 3.2 实施步骤

#### Phase 1: 统一导出入口 (优先级: 高)
```typescript
// 新建文件: src/utils/reportExporter.ts

/**
 * 统一的评估报告导出函数
 */
export async function exportAssessmentReport(
  elementId: string,
  filename: string,
  type: 'sm' | 'weefim' | 'training'
): Promise<void> {
  // 统一使用 printHelper.ts 的方案
  const { exportToPDFSimple } = await import('./printHelper')
  return exportToPDFSimple(elementId, filename)
}
```

#### Phase 2: 修改WeeFIM报告 (优先级: 高)
```typescript
// 文件: src/views/assessment/weefim/Report.vue

// 修改前
const exportPDF = async () => {
  await exportSimpleReport('report-content', filename, 'weefim', reportDataForExport)
}

// 修改后
import { exportAssessmentReport } from '@/utils/reportExporter'

const exportPDF = async () => {
  await exportAssessmentReport(
    'report-content',
    `WeeFIM评估报告_${student.value?.name}_${new Date().toLocaleDateString()}`,
    'weefim'
  )
}
```

#### Phase 3: 优化 printHelper.ts (优先级: 中)
- 添加对不同报告类型的样式适配
- 优化图表转换性能(缓存、懒加载)
- 增强错误处理和用户提示

#### Phase 4: 保留降级方案 (优先级: 低)
- 保留 `simpleReportPrinter` 作为快速导出选项
- 当图表转换失败时自动降级
- 添加用户选择: "标准导出" vs "快速导出"

---

## 四、报告管理模块设计

### 4.1 功能规划

```
报告生成模块 (Reports.vue)
├── 报告列表展示
│   ├── 学生筛选(下拉选择)
│   ├── 报告类型筛选(S-M/WeeFIM/训练报告 - Tab切换)
│   ├── 时间范围筛选(日期选择器)
│   └── 报告列表(卡片视图)
│
├── 报告操作
│   ├── 查看详情(跳转到现有Report页面)
│   ├── 下载PDF(调用统一导出函数)
│   ├── 下载Word(使用exportUtils)
│   ├── 打印报告(浏览器原生打印)
│   └── 删除报告(带确认)
│
└── 数据统计
    ├── 报告总数统计
    ├── 各类型报告数量
    └── 最近生成记录
```

### 4.2 数据库表设计

```sql
-- 报告记录表
CREATE TABLE report_record (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  student_id INTEGER NOT NULL,           -- 学生ID
  report_type TEXT NOT NULL,              -- 报告类型: 'sm' | 'weefim' | 'training'
  assess_id INTEGER,                      -- 评估记录ID (可为空,训练报告时)
  plan_id INTEGER,                        -- 训练计划ID (可为空,评估报告时)
  file_path_pdf TEXT,                     -- PDF文件路径(可选,如果不保存文件则为空)
  file_path_word TEXT,                    -- Word文件路径(可选)
  title TEXT NOT NULL,                     -- 报告标题
  created_at TEXT NOT NULL,               -- 创建时间
  updated_at TEXT,                        -- 更新时间

  FOREIGN KEY (student_id) REFERENCES student(id),
  FOREIGN KEY (assess_id) REFERENCES sm_assess(id),
  FOREIGN KEY (plan_id) REFERENCES train_plan(id)
);

-- 索引
CREATE INDEX idx_report_student ON report_record(student_id);
CREATE INDEX idx_report_type ON report_record(report_type);
CREATE INDEX idx_report_created ON report_record(created_at DESC);
```

### 4.3 页面路由配置

```typescript
// router/index.ts
{
  path: 'reports',
  name: 'Reports',
  component: Reports,  // 新建页面
  meta: {
    title: '报告生成',
    icon: 'chart-column',
    roles: ['admin', 'teacher']
  }
}
```

---

## 五、开发计划

### 5.1 Phase 1 - 报告记录与列表 (1-2天)
- [ ] 设计并创建 `report_record` 表
- [ ] 在评估完成时自动保存报告记录
  - [ ] S-M评估完成时保存记录
  - [ ] WeeFIM评估完成时保存记录
- [ ] 创建 `Reports.vue` 页面
  - [ ] 报告列表展示(卡片布局)
  - [ ] 筛选和搜索功能
  - [ ] 分页功能

### 5.2 Phase 2 - 报告查看与下载 (1天)
- [ ] 报告详情查看
  - [ ] 点击卡片跳转到对应Report页面
- [ ] 批量操作
  - [ ] 批量下载
  - [ ] 批量删除
- [ ] 单个报告操作
  - [ ] 下载PDF按钮
  - [ ] 下载Word按钮
  - [ ] 删除报告(二次确认)

### 5.3 Phase 3 - PDF导出统一优化 (1天)
- [ ] 创建统一导出函数 `reportExporter.ts`
- [ ] 修改WeeFIM报告使用统一导出
- [ ] 优化图表转换性能
- [ ] 增强错误处理

### 5.4 Phase 4 - 扩展功能 (后续)
- [ ] 训练报告模板设计
- [ ] 训练报告集成
- [ ] 报告对比分析
- [ ] 批量生成报告
- [ ] 报告模板自定义(学校Logo、页眉页脚)

---

## 六、关键技术点

### 6.1 报告记录自动保存

```typescript
// 在评估完成时自动保存报告记录
// src/views/assessment/sm/Assessment.vue

async function finishAssessment() {
  // ... 现有的评估完成逻辑

  // 保存评估结果后,自动创建报告记录
  const assessmentId = await api.saveAssessment(assessmentData)

  // 保存报告记录
  await api.saveReportRecord({
    student_id: studentId.value,
    report_type: 'sm',
    assess_id: assessmentId,
    title: `S-M量表评估报告_${student.value.name}_${new Date().toLocaleDateString()}`,
    created_at: new Date().toISOString()
  })
}
```

### 6.2 统一导出函数使用

```typescript
// src/views/Reports.vue

const exportReportPDF = async (record: ReportRecord) => {
  try {
    // 根据报告类型跳转到对应报告页面
    const routeMap = {
      'sm': `/assessment/sm/report?assessId=${record.assess_id}&studentId=${record.student_id}`,
      'weefim': `/assessment/weefim/report?assessId=${record.assess_id}&studentId=${record.student_id}`,
      'training': `/training/report?planId=${record.plan_id}&studentId=${record.student_id}`
    }

    // 方案1: 直接在新窗口打开报告页面,用户手动导出
    window.open(routeMap[record.report_type], '_blank')

    // 方案2: 后续实现静默导出(需要后端支持)
    // await exportReportById(record.id)
  } catch (error) {
    ElMessage.error('导出失败: ' + error.message)
  }
}
```

### 6.3 API接口设计

```typescript
// src/database/api/index.ts

export class ReportAPI {
  /**
   * 保存报告记录
   */
  async saveReportRecord(record: {
    student_id: number
    report_type: 'sm' | 'weefim' | 'training'
    assess_id?: number
    plan_id?: number
    title: string
    created_at: string
  }): Promise<number> {
    // 实现保存逻辑
  }

  /**
   * 获取报告列表
   */
  async getReportList(filters: {
    student_id?: number
    report_type?: string
    start_date?: string
    end_date?: string
    page?: number
    limit?: number
  }): Promise<ReportRecord[]> {
    // 实现查询逻辑
  }

  /**
   * 删除报告记录
   */
  async deleteReportRecord(id: number): Promise<void> {
    // 实现删除逻辑
  }

  /**
   * 获取报告详情
   */
  async getReportRecord(id: number): Promise<ReportRecord | null> {
    // 实现查询逻辑
  }
}
```

---

## 七、技术选型建议

### 7.1 PDF生成技术对比

| 技术方案 | 优点 | 缺点 | 推荐度 |
|---------|------|------|--------|
| **浏览器打印(window.print)** | 无需额外依赖,兼容性好 | 需要用户手动操作 | ⭐⭐⭐⭐ |
| **html2canvas + print** | 保留样式,图表真实 | 性能开销,弹窗问题 | ⭐⭐⭐⭐⭐ (当前使用) |
| **jsPDF** | 纯前端生成,可控性强 | 样式还原差,图表支持差 | ⭐⭐ |
| **pdfkit** | 功能强大,样式精确 | 学习成本高,体积大 | ⭐⭐⭐ |
| **服务端生成** | 稳定可靠,可批量生成 | 需要后端支持 | ⭐⭐⭐⭐ (未来) |

### 7.2 推荐技术栈

**当前阶段(前端生成)**:
- PDF: `html2canvas` + 浏览器打印
- Word: `docx` 库
- 图表: ECharts (已使用)

**未来扩展(服务端生成)**:
- PDF: `pdfkit` (Node.js)
- Word: `docx` (Node.js)
- 模板引擎: `handlebars` 或 `ejs`

---

## 八、注意事项

### 8.1 浏览器兼容性
- `window.print()` 在所有现代浏览器都支持
- `html2canvas` 在IE11及以下不支持(可接受)
- 建议用户使用Chrome/Edge以获得最佳体验

### 8.2 性能优化
- 图表转换建议添加Loading提示
- 大报告建议分页或分章节生成
- 考虑使用Web Worker进行图表转换

### 8.3 用户体验
- 导出前明确提示用户操作步骤
- 提供多种导出格式选择(PDF/Word)
- 考虑添加"快速导出"选项(简化版)

### 8.4 数据安全
- 报告记录包含敏感学生信息,需要权限控制
- 导出的文件建议加密或添加水印
- 定期清理过期的临时文件

---

## 九、待确认问题

1. **报告存储方式**:
   - [ ] 是否需要将生成的PDF/Word文件保存到本地?
   - [ ] 还是只保存数据库记录,需要时重新生成?

2. **报告列表入口**:
   - [ ] 放在侧边栏菜单"报告生成"下?
   - [ ] 还是放在每个学生详情页的"评估记录"标签下?

3. **训练报告**:
   - [ ] 训练报告是否需要和评估报告类似的样式?
   - [ ] 还是更简化一些?

4. **数据导出**:
   - [ ] 是否需要导出Excel格式的统计数据?
   - [ ] 还是只需要PDF和Word?

5. **统一导出时机**:
   - [ ] 是否现在就统一WeeFIM使用printHelper?
   - [ ] 还是等报告管理模块完成后再统一?

---

## 十、参考资料

### 相关文档
- PRD文档: `/docs/planning/prd.md` - 第2.6节"报告生成"
- 开发计划: `/docs/planning/开发计划.md`
- 26项量表设计: `/docs/planning/27项生活自理任务标准化评估量表设计.md`

### 相关代码文件
- S-M报告页面: `src/views/assessment/sm/Report.vue`
- WeeFIM报告页面: `src/views/assessment/weefim/Report.vue`
- printHelper: `src/utils/printHelper.ts`
- simpleReportPrinter: `src/utils/simpleReportPrinter.ts`
- exportUtils: `src/utils/exportUtils.ts`

### 依赖库
- html2canvas: ^1.4.1 (已安装)
- echarts: ^5.x (已安装)
- docx: (如需Word导出,需要安装)

---

## 十一、版本记录

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|---------|--------|
| 1.0 | 2025-12-25 | 初始版本,记录现状分析和方案建议 | Claude |

---

**文档结束**
